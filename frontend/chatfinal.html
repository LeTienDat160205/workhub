<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>WorkHub — ChatDep</title>
<style>
:root{
  --primary:#4caf50;
  --green:#22c55e;
  --green-2:#16a34a;
  --bg:#f5f7f8;
  --surface:#ffffff;
  /* bubble/avatar color tokens */
  --bubble-bg: #f3fff4;
  --bubble-border: var(--border);
  --avatar-bg: #dff6e6;
  --avatar-text: var(--green-2);
  --muted:#64748b;
  --border:#e6eef8;
  --radius:12px;
  --shadow:0 8px 30px rgba(15,23,36,0.04);
  --text:#0f1724;
  --chat-input-bg: #f3f7f5;
}
[data-theme="dark"]{
  --primary:#66bb6a;
  --green:#4caf50;
  --green-2:#2e7d32;
  --bg:#07121a;
  --surface:#0f1724;
  /* dark mode bubble/avatar adjustments */
  --bubble-bg: rgba(255,255,255,0.03);
  --bubble-border: rgba(255,255,255,0.06);
  --avatar-bg: rgba(102,187,106,0.12);
  --avatar-text: var(--primary);
  --muted:#9aa0a6;
  --border:#263238;
  --text:#e6eef8;
  --shadow:0 12px 48px rgba(0,0,0,0.6);
  --chat-input-bg: #0b1a12;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
.dashboard-frame{position:relative;height:100vh;display:flex;flex-direction:column;padding:8px}

/* Header copied-in style like index8.html */
.dashboard-header{
  display:grid;grid-template-columns:200px auto;gap:12px;align-items:center;padding:14px 22px;border-radius:8px;background:var(--surface);box-shadow:var(--shadow);margin:10px;border:1px solid var(--border);
}
.logo-bar{display:flex;align-items:center;gap:14px}
.site-name{font-weight:900;font-size:32px;color:var(--green);letter-spacing:1px}
.header-actions{justify-self:end;display:flex;align-items:center;gap:12px}
.icon-btn{background:var(--green);color:#fff;border:none;border-radius:10px;padding:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(34,197,94,0.12)}
.icon-btn:hover{filter:brightness(0.97)}
.user-account{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 12px;border-radius:16px;background:var(--surface);border:1px solid var(--border)}
.user-avatar{width:36px;height:36px;border-radius:50%;background:var(--avatar-bg);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--avatar-text);border:2px solid rgba(255,255,255,0.08)}

/* Body */
.dashboard-body{flex:1;display:flex;min-height:0;padding:10px;gap:10px}

/* Sidebar groups */
.sidebar{width:260px;background:var(--surface);border-radius:10px;padding:18px;display:flex;flex-direction:column;border:1px solid var(--border);box-shadow:var(--shadow);margin:5px 0 10px 10px;height:calc(100% - 30px)}
.mini-pill{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:transparent;border:1px solid var(--border)}
.mini-pill svg{opacity:0.8}
.mini-pill input{border:0;background:transparent;outline:0;width:100%}
.sidebar-list{flex:1;overflow:auto;margin-top:12px;padding:8px;border-radius:8px;background:var(--surface);border:1px solid var(--border)}
.group-item{padding:12px;border-radius:8px;background:var(--surface);margin-bottom:10px;cursor:pointer;border:1px solid #f1f6f2;font-weight:700}
.create-group-btn{margin-top:12px;padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--green),var(--primary));color:#fff;cursor:pointer;font-weight:800;box-shadow:0 8px 18px rgba(34,197,94,0.12)}

/* Main */
.main-content{flex:1;display:flex;flex-direction:column;gap:12px;margin-right:0;min-width:0} /* min-width:0 to fix flex overflow */

/* REMOVED: main-toolbar (Hệ thống công việc) */
/* We intentionally removed the toolbar so chat area grows taller */

/* chatbar - kept the smaller chat header above chat area */
.chatbar{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--border);background:var(--surface)}
.chatbar .title-group{font-weight:800}
.chatbar .meta{color:var(--muted);font-size:13px;margin-left:8px}

/* content - chat area */
/* make content-task stretch fully like side panels */
.content-task{flex:1;overflow:hidden;border-radius:10px;padding:0;background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow);position:relative;display:flex;flex-direction:column}
.content-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.chat-messages{flex:1;overflow:auto;padding:18px;min-height:0; /* important to let flex children shrink/grow */ background-image: linear-gradient(to bottom, rgba(0,0,0,0.04) 1px, transparent 1px); background-size: 100% 28px; background-color: transparent;}
.message{display:flex;gap:10px;margin:6px 0;align-items:flex-start}
.message .avatar{flex:0 0 44px;width:44px;height:44px;min-width:44px;min-height:44px;border-radius:50%;background:var(--avatar-bg);color:var(--avatar-text);display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
.message > div{flex:1;min-width:0} /* allow bubble to stretch and wrap inside flex */
.message .bubble{background:var(--bubble-bg);padding:6px 10px;border-radius:10px;max-width:48%;width:calc(50% - 56px);/* approx half width */border:1px solid var(--bubble-border);position:relative;color:var(--text);font-size:13.5px;line-height:1.18}
.message .meta{font-size:10px;color:var(--muted);margin-top:4px}

/* CHAT INPUT: make full width, rounded, modern */
.chat-input{
  display:flex;
  padding:12px 18px; /* align with chat messages padding */
  border-top:1px solid var(--border);
  align-items:center;
  background:transparent;
}
.chat-input .chat-input-inner{display:flex;align-items:center;gap:10px;width:100%;max-width:100%}
.chat-input .file-btn{width:48px;height:48px;border-radius:12px;background:transparent;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.chat-input-wrapper{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  background:var(--chat-input-bg);
  border-radius:12px; /* slightly less extreme rounding for better fit */
  width:100%;
  box-shadow:0 6px 18px rgba(2,6,23,0.04);
  border:1px solid rgba(0,0,0,0.04);
}
.chat-input-wrapper input[type="text"], .chat-input-wrapper input{
  border:0;
  outline:0;
  background:transparent;
  padding:8px 12px;
  font-size:15px;
  flex:1; /* full width */
  min-width:0; /* prevent overflow in flexbox */
}
.chat-input-wrapper .send-btn{
  padding:10px 14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--green),var(--primary));color:#fff;cursor:pointer;flex-shrink:0;
}

/* Right column: members */
.right-column{width:320px;display:flex;flex-direction:column;gap:12px;margin-right:10px}
.right-panel{background:var(--surface);border-radius:10px;padding:12px;border:1px solid var(--border);box-shadow:var(--shadow);display:flex;flex-direction:column;height:calc(100% - 20px)}
.right-panel .search-members{margin-bottom:10px}
.member-item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:8px;background:transparent;border:1px solid transparent;cursor:pointer}
.member-item:hover{background:rgba(34,197,94,0.04)}
.member-item .avatar{flex:0 0 44px;width:44px;height:44px;min-width:44px;min-height:44px;border-radius:50%;background:var(--avatar-bg);color:var(--avatar-text);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid rgba(255,255,255,0.06);overflow:hidden}
.member-list{overflow:auto;flex:1;padding-right:6px}

/* member menu - left aligned to clicked item */
.member-menu{position:fixed;background:var(--surface);border:1px solid var(--border);box-shadow:0 12px 40px rgba(0,0,0,0.12);border-radius:10px;padding:6px 8px;z-index:400;display:none;min-width:170px}
.member-menu button{display:block;padding:8px 12px;border:none;background:none;width:100%;text-align:left;cursor:pointer;border-radius:8px}
.member-menu button:hover{background:rgba(34,197,94,0.06)}

/* popup add members (from addmembers.html) */
.popup-overlay{display:none;position:fixed;inset:0;background:rgba(49,130,206,0.10);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.popup-overlay.active{display:flex}
.popup-content{width:500px;min-height:420px;background:rgba(255,255,255,0.98);border-radius:18px;box-shadow:0 12px 48px rgba(49,130,206,0.16);position:relative;display:flex;flex-direction:column;padding:32px;border:1.5px solid #e0e7ff}
.popup-title{font-size:1.25rem;font-weight:600;color:var(--green);text-align:center;margin-bottom:12px}
.autocomplete-wrapper{position:relative;margin:0 auto 12px;width:340px}
.autocomplete-input{width:100%;padding:9px 12px;border:1.5px solid #d1d5db;border-radius:6px;background:#f8fafc}
.autocomplete-list{position:absolute;top:110%;left:0;right:0;background:#fff;border:1.5px solid #e0e7ff;border-radius:6px;box-shadow:0 2px 8px rgba(37,99,235,0.13);z-index:60;max-height:180px;overflow:auto;display:none}
.autocomplete-item{display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer}
.selected-list{margin:10px auto 0;padding:0;list-style:none;width:340px}
.selected-item{display:flex;align-items:center;gap:10px;background:#f3f4f6;border-radius:7px;padding:7px 12px;margin-bottom:7px;border:1.5px solid #e0e7ff}
.confirm-btn{width:340px;margin:18px auto 0;padding:10px 0;border-radius:7px;border:none;background:linear-gradient(90deg,#3182ce 60%,#2563eb 100%);color:#fff;font-weight:600}

/* small helpers */
.badge{background:var(--green);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800}
.muted{color:var(--muted)}
.hide{display:none}

/* right panel stack (calendar & notif) - copied behavior */
.right-panel-stack{position:fixed;top:calc(72px + 10px);right:18px;display:flex;flex-direction:column;gap:12px;z-index:1000}
.right-panel-half{width:360px;height:0;overflow:hidden;border-left:2px solid var(--border);background:var(--surface);border-radius:8px;transition:height .35s,transform .35s,opacity .25s;transform:translateX(100%);opacity:0;pointer-events:none}
.right-panel-half.show{height:48%;transform:translateX(0);opacity:1;pointer-events:auto}
.panel-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);background:#f1f6f2}
.panel-title{display:flex;align-items:center;gap:8px;color:var(--green);font-weight:800}
.notif-list{padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto;max-height:calc(48% - 70px)}
.notif-item{display:flex;align-items:center;gap:12px;padding:12px;background:#fff;border-radius:8px;border:1px solid var(--border);box-shadow:0 6px 18px #00000004}
.notif-dot{width:18px;height:18px;border-radius:6px;background:var(--green);display:flex;align-items:center;justify-content:center}
.notif-time{font-size:12px;color:var(--muted);margin-left:auto}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;padding:12px;background:#fff;border-radius:6px}
.calendar-grid .dow{height:28px;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
.calendar-grid .cell{height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:#f9fafb;border:1px solid #eef2f7;cursor:pointer}
.calendar-grid .cell.faded{opacity:.45;background:#e0e7ff;color:var(--muted)}
.calendar-grid .cell.today{outline:3px solid var(--green);background:#d1fae0;font-weight:800}

/* responsiveness: allow main area to shrink gracefully */
@media (max-width: 1000px){
  .dashboard-body{flex-direction:column}
  .sidebar{width:100%;height:auto}
  .right-column{width:100%;height:auto;margin-right:0}
  .main-content{margin-right:0}
}

</style>
</head>
<body>
<div class="dashboard-frame">
  <!-- HEADER (replaced with index8-style header + inline userMenu) -->
  <div class="dashboard-header">
    <div class="logo-bar">
      <span class="site-name" style="font-size:32px;">WorkHub</span>
    </div>
    <div class="header-actions actions-cluster">
      <button class="icon-btn" title="Menu" aria-label="Menu" id="btnMenu">☰</button>
      <button class="icon-btn" id="btnTheme" title="Chuyển chế độ sáng/tối" aria-pressed="false">
        <span id="themeIcon">🌙</span>
      </button>
      <button class="icon-btn" id="btnCalendar" title="Lịch" aria-label="Lịch">📅</button>
      <button class="icon-btn" id="btnNotif" title="Thông báo" aria-label="Thông báo">🔔</button>

      <div class="user-account" id="openProfile" title="Account" style="position:relative">
        <div style="position: relative">
          <div class="user-avatar">A</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;">
          <span style="font-weight:800">Tên người dùng</span>
          <span style="font-size:12px;color:var(--muted)">@example.com</span>
        </div>
        <svg style="margin-left: 8px" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 9l6 6 6-6" />
        </svg>

        <!-- INLINE USER MENU (matches index8 structure) -->
        <div id="userMenu" style="display:none;position:absolute;top:64px;right:0;background:var(--surface);border:1px solid var(--border);padding:8px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.12);min-width:200px;z-index:1200">
          <button style="width:100%;text-align:left;background:none;border:none;padding:10px;color:var(--green);font-weight:700" id="Profile">Xem thông tin</button>
          <button style="width:100%;text-align:left;background:none;border:none;padding:10px;color:var(--green);font-weight:700" id="OpenSettings">Cài đặt</button>
          <button style="width:100%;text-align:left;background:none;border:none;padding:10px;color:#ef4444;font-weight:700" id="Logout">Đăng xuất</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Minimal Profile popup (added to support header menu) -->
  <div id="popupProfile" class="popup-overlay" aria-hidden="true">
    <div class="popup-content" role="dialog" style="width:420px;max-width:95vw">
      <button class="close-btn" id="closeProfileBtn" aria-label="Đóng" style="position:absolute;top:12px;right:16px;border:none;background:none;font-size:22px">&times;</button>
      <div style="font-weight:800;color:var(--green);font-size:18px;margin-bottom:12px">Thông tin tài khoản</div>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:84px;height:84px;border-radius:50%;background:#dff6e6;display:flex;align-items:center;justify-content:center;font-weight:800">A</div>
        <div>
          <div style="font-weight:800">Tên người dùng</div>
          <div style="color:var(--muted)">@example.com</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Minimal WorkHub settings overlay -->
  <div id="whSettings" class="popup-overlay" style="display:none;" aria-hidden="true">
    <div class="popup-content" role="dialog" style="width:760px;max-width:95vw">
      <button class="close-btn" id="whClose" aria-label="Đóng" style="position:absolute;top:12px;right:16px;border:none;background:none;font-size:22px">&times;</button>
      <div style="font-weight:800;color:var(--green);font-size:18px;margin-bottom:12px">Cài đặt WorkHub</div>
      <div style="color:var(--muted)">Các tuỳ chọn cài đặt nhanh hiển thị ở đây.</div>
    </div>
  </div>

  <!-- body -->
  <div class="dashboard-body">
    <!-- sidebar -->
    <div class="sidebar">
      <div class="mini-pill">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7" stroke-width="2"/><line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"/></svg>
        <input id="groupSearch" placeholder="Tìm kiếm group...">
      </div>
      <div id="groupList" class="sidebar-list"></div>
      <button id="btnAddGroup" class="create-group-btn">Tạo nhóm</button>
    </div>

    <!-- main content (chat) -->
    <div class="main-content">

      <!-- NOTE: 'main-toolbar' (Hệ thống công việc) REMOVED so chat area can be taller -->

      <div class="content-task">
        <div class="content-header chatbar">
          <div>
            <span class="title-group" id="groupTitle">Group 1</span>
            <div class="meta" id="memberCount">2 thành viên</div>
          </div>
          <div>
            <button id="btnAddMemberInline" class="create-group-btn" style="padding:8px 12px;border-radius:8px;font-size:14px">+ Thêm thành viên</button>
            <button id="btnCreateTask" class="create-group-btn" style="padding:8px 12px;border-radius:8px;font-size:14px;background:linear-gradient(90deg,var(--green),var(--primary));margin-left:8px">Tạo công việc</button>
          </div>
        </div>

        <!-- Chat messages: this element now grows to fill the available height (equal to right panel) -->
        <div id="chatMessages" class="chat-messages" role="log" aria-live="polite"></div>

        <!-- Chat input: full width, rounded -->
        <div class="chat-input" aria-label="Nhập tin nhắn">
          <div class="chat-input-inner">
            <label class="file-btn" title="Gửi tệp"><input id="fileInput" type="file" style="display:none"/>📎</label>
            <div style="flex:1">
              <div class="chat-input-wrapper">
                <input id="chatInput" placeholder="Nhập tin nhắn..." />
                <button id="sendBtn" class="send-btn" aria-label="Gửi">Gửi</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- right column (members) -->
    <div class="right-column">
      <div class="right-panel">
        <div class="search-members">
          <div class="mini-pill">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7" stroke-width="2"/></svg>
            <input id="memberSearch" placeholder="Tìm kiếm thành viên...">
          </div>
        </div>
        <div class="member-list" id="membersWrap"></div>
      </div>
    </div>

  </div>

  <!-- right panel stack (calendar & notif) -->
  <div class="right-panel-stack" id="rightStack">
    <div class="right-panel-half" id="calendarPanel">
      <div class="panel-head">
        <div class="panel-title">📅 Lịch</div>
        <div><button class="btn" id="prevMth">◀</button><button class="btn" id="nextMth">▶</button></div>
      </div>
      <div style="padding:10px" id="calendarContent">
        <div style="padding:8px;background:#f8fafc;border-radius:8px;border:1px solid var(--border)">
          <div id="titleDay" style="font-weight:700">Mon, Sep 29</div>
          <div id="subMonth" style="font-size:13px;color:var(--muted)">SEPTEMBER 2025</div>
        </div>
        <div class="calendar-grid" id="calGrid" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="right-panel-half" id="notifPanel">
      <div class="panel-head">
        <div class="panel-title">🔔 Thông báo</div>
        <div><button class="close-btn" id="closeNotifPanel">&times;</button></div>
      </div>
      <div class="notif-list" id="notifList"></div>
    </div>
  </div>

  <!-- member floating menu -->
  <div id="memberMenu" class="member-menu" role="menu" aria-hidden="true">
    <button id="menuView">👁️ Xem thông tin</button>
    <button id="menuMessage">💬 Nhắn tin</button>
    <button id="menuRemove" style="color:#ef4444">🗑️ Xóa thành viên</button>
  </div>

  <!-- popup add members -->
  <div id="popupAddMembers" class="popup-overlay" aria-hidden="true">
    <div class="popup-content" role="dialog">
      <button class="close-btn" id="closeAddPopup" aria-label="Đóng" style="position:absolute;top:12px;right:16px;border:none;background:none;font-size:22px">&times;</button>
      <div class="popup-title">Mời thành viên</div>
      <label style="text-align:center;color:var(--muted);display:block;margin-bottom:8px">Nhập tên tài khoản (username) hoặc email</label>
      <div class="autocomplete-wrapper">
        <input id="autocompleteInput" class="autocomplete-input" placeholder="Tên tài khoản hoặc email" autocomplete="off">
        <div id="autocompleteList" class="autocomplete-list"></div>
      </div>
      <ul id="selectedList" class="selected-list"></ul>
      <button id="confirmAddBtn" class="confirm-btn">Xác nhận</button>
    </div>
  </div>

  <!-- popup create group -->
  <div id="popupGroup" class="popup-overlay" aria-hidden="true">
    <div class="popup-content" role="dialog" style="width:360px;padding:20px">
      <button class="close-btn" id="closeGroupPopup" style="position:absolute;top:8px;right:12px;border:none;background:none;font-size:22px">&times;</button>
      <div style="font-weight:800;color:var(--green);font-size:18px;margin-bottom:12px">Tạo nhóm mới</div>
      <form id="groupForm" style="display:flex;flex-direction:column;gap:10px">
        <input id="groupName" placeholder="Tên nhóm" style="padding:10px;border-radius:8px;border:1px solid var(--border)">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button type="button" id="cancelGroupBtn" style="background:#9e9e9e;color:#fff;padding:8px 12px;border-radius:8px;border:none">Huỷ</button>
          <button type="submit" style="background:var(--green);color:#fff;padding:8px 12px;border-radius:8px;border:none">Tạo nhóm</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
// ---------- Data ----------
let groups = [{name:"Group 1", leader:"Nguyễn Văn A"},{name:"Group 2", leader:"Trần Thị B"}];
let members = [{id:1,name:"Người dùng 1",handle:"@u1"},{id:2,name:"Người dùng 2",handle:"@u2"}];
let usersForInvite = [
  { id: 1, username: "vana", name: "Nguyễn Văn A", email: "vana@example.com", avatar: "https://i.pravatar.cc/80?img=32" },
  { id: 2, username: "thib", name: "Trần Thị B", email: "thib@example.com", avatar: "https://i.pravatar.cc/80?img=44" },
  { id: 3, username: "vanc", name: "Lê Văn C", email: "vanc@example.com", avatar: "https://i.pravatar.cc/80?img=45" },
  { id: 4, username: "minhd", name: "Phạm Minh D", email: "minhd@example.com", avatar: "https://i.pravatar.cc/80?img=46" },
  { id: 5, username: "thie", name: "Ngô Thị E", email: "thie@example.com", avatar: "https://i.pravatar.cc/80?img=47" }
];
let notifs = [
  {text:"Nguyễn Văn A đã tạo nhóm 'Nhóm A'", time:"2 giờ trước"},
  {text:"Bạn được thêm vào Group 2", time:"Hôm qua"},
  {text:"Báo cáo tuần đã được gửi", time:"3 ngày trước"}
];

// ---------- Render groups ----------
const groupListEl = document.getElementById('groupList');
function renderGroups(filter=""){
  groupListEl.innerHTML = groups.filter(g=>g.name.toLowerCase().includes(filter.toLowerCase())).map((g,i)=>`<div class="group-item" data-idx="${i}">${g.name}<div style="font-size:12px;color:var(--muted);font-weight:600">Nhóm trưởng: ${g.leader||''}</div></div>`).join('');
}
renderGroups();
document.getElementById('groupSearch').addEventListener('input', e=> renderGroups(e.target.value));
groupListEl.addEventListener('click', e=>{
  const item = e.target.closest('.group-item');
  if(!item) return;
  const idx = Number(item.getAttribute('data-idx'));
  document.getElementById('groupTitle').textContent = groups[idx].name;
});

// ---------- Render members ----------
const membersWrap = document.getElementById('membersWrap');
const memberCountEl = document.getElementById('memberCount');
function renderMembers(filter=""){
  membersWrap.innerHTML = members.filter(m=> (m.name + ' ' + m.handle).toLowerCase().includes(filter.toLowerCase())).map(m=>`
    <div class="member-item" data-id="${m.id}">
      <div class="avatar">${m.name.charAt(0)}</div>
      <div style="flex:1">
        <div style="font-weight:800">${m.name}</div>
        <div style="font-size:13px;color:var(--muted)">${m.handle}</div>
      </div>
    </div>
  `).join('');
  memberCountEl.textContent = members.length + " thành viên";
}
renderMembers();
document.getElementById('memberSearch').addEventListener('input', e=> renderMembers(e.target.value));

// ---------- Member floating menu (left) ----------
const memberMenu = document.getElementById('memberMenu');
let activeMemberId = null;
document.addEventListener('click', e=>{
  if(!e.target.closest('.member-item') && !e.target.closest('#memberMenu')) {
    memberMenu.style.display='none';
    activeMemberId = null;
  }
});
membersWrap.addEventListener('click', e=>{
  const item = e.target.closest('.member-item');
  if(!item) return;
  const rect = item.getBoundingClientRect();
  const menuW = memberMenu.offsetWidth || 170;
  const left = Math.max(8, rect.left - menuW - 10);
  const top = rect.top + (rect.height/2) - (memberMenu.offsetHeight/2);
  memberMenu.style.left = left + 'px';
  memberMenu.style.top = (top + window.scrollY) + 'px';
  memberMenu.style.display = 'block';
  activeMemberId = Number(item.getAttribute('data-id'));
});

// menu actions
document.getElementById('menuView').onclick = ()=> {
  const m = members.find(mm=>mm.id===activeMemberId);
  if(m) alert('Xem thông tin:\n' + m.name + ' ' + m.handle);
  memberMenu.style.display='none';
};
document.getElementById('menuMessage').onclick = ()=> {
  const m = members.find(mm=>mm.id===activeMemberId);
  if(m){
    const txt = prompt('Nhắn tin đến ' + m.name + ':');
    if(txt) addChatMessage('Bạn -> ' + m.name, txt);
  }
  memberMenu.style.display='none';
};
document.getElementById('menuRemove').onclick = ()=> {
  if(!activeMemberId) return;
  const idx = members.findIndex(mm=>mm.id===activeMemberId);
  if(idx>=0 && confirm('Xóa thành viên ' + members[idx].name + ' ?')) {
    members.splice(idx,1);
    renderMembers();
  }
  memberMenu.style.display='none';
};

// ---------- Chat send & file attach (with sender, time) ----------
const sendBtn = document.getElementById('sendBtn');
const chatInput = document.getElementById('chatInput');
const chatMessages = document.getElementById('chatMessages');

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function timeNow(){ const d=new Date(); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
function addChatMessage(sender, txt){
  const div = document.createElement('div');
  div.className = 'message';
  const html = `<div class="avatar">${escapeHtml(sender.charAt(0))}</div>
    <div>
      <div class="bubble"><strong>${escapeHtml(sender)}</strong><div style="margin-top:8px">${escapeHtml(txt)}</div></div>
      <div class="meta">${timeNow()}</div>
    </div>`;
  div.innerHTML = html;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
sendBtn.addEventListener('click', ()=> {
  const txt = chatInput.value.trim();
  if(!txt) return;
  addChatMessage('Bạn', txt);
  chatInput.value='';
});
document.getElementById('fileInput').addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const div = document.createElement('div');
  div.className = 'message';
  div.innerHTML = `<div class="avatar">T</div><div><div class="bubble">📎 <strong>${escapeHtml(f.name)}</strong></div><div class="meta">${timeNow()}</div></div>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  e.target.value='';
});

// ---------- Theme toggle & panels (copied behavior) ----------
const THEME_KEY='workhub-theme';
const themeBtn=document.getElementById('btnTheme');
(function(){ const s=localStorage.getItem(THEME_KEY)||'light'; if(s==='dark') document.documentElement.setAttribute('data-theme','dark'); themeBtn.textContent = document.documentElement.getAttribute('data-theme')==='dark' ? '☀️' : '🌙'; })();
themeBtn.addEventListener('click', ()=> {
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  const next = cur==='light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(THEME_KEY,next);
  themeBtn.textContent = next==='dark' ? '☀️' : '🌙';
});

// ---------- Panels: calendar & notif (stacked behavior like index8) ----------
const calendarPanel = document.getElementById('calendarPanel');
const notifPanel = document.getElementById('notifPanel');
const btnCalendar = document.getElementById('btnCalendar');
const btnNotif = document.getElementById('btnNotif');
const closeNotifPanel = document.getElementById('closeNotifPanel');

let panelOrder = [];
function showPanel(panel){
  if(panelOrder.includes(panel)){ closePanel(panel); return; }
  panelOrder = [panel, ...panelOrder].slice(0,2);
  updatePanels();
}
function closePanel(panel){
  panelOrder = panelOrder.filter(p=>p!==panel);
  updatePanels();
}
function updatePanels(){
  calendarPanel.classList.remove('show');
  notifPanel.classList.remove('show');
  if(panelOrder[0]==='calendar') calendarPanel.classList.add('show');
  if(panelOrder[0]==='notif') notifPanel.classList.add('show');
  if(panelOrder[1]==='calendar') calendarPanel.classList.add('show');
  if(panelOrder[1]==='notif') notifPanel.classList.add('show');
}
btnCalendar.onclick = ()=> showPanel('calendar');
btnNotif.onclick = ()=> showPanel('notif');
closeNotifPanel.onclick = ()=> closePanel('notif');
document.addEventListener('mousedown', (e)=>{
  if(notifPanel.classList.contains('show') && !notifPanel.contains(e.target) && !btnNotif.contains(e.target)) closePanel('notif');
  if(calendarPanel.classList.contains('show') && !calendarPanel.contains(e.target) && !btnCalendar.contains(e.target)) closePanel('calendar');
});

// ---------- Calendar logic (from template) ----------
function initCalendar(){
  const calGrid = document.getElementById('calGrid');
  const titleDay = document.getElementById('titleDay');
  const subMonth = document.getElementById('subMonth');
  const prevMth = document.getElementById('prevMth');
  const nextMth = document.getElementById('nextMth');
  let view = new Date();
  function headText(d){
    const w = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][d.getDay()];
    const m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()];
    return `${w}, ${m} ${String(d.getDate()).padStart(2,"0")}`;
  }
  function buildCalendar(date){
    const y = date.getFullYear(), m = date.getMonth();
    titleDay.textContent = headText(new Date());
    subMonth.textContent = new Intl.DateTimeFormat("en-US",{month:"long",year:"numeric"}).format(new Date(y,m,1)).toUpperCase();
    const first = new Date(y,m,1);
    const start = (first.getDay() + 6) % 7; // Monday first
    const days = new Date(y,m+1,0).getDate();
    const prevDays = new Date(y,m,0).getDate();
    const parts = [];
    ["M","T","W","T","F","S","S"].forEach(d=>parts.push(`<div class="dow">${d}</div>`));
    for(let i=0;i<42;i++){
      let label, cls="cell";
      if(i < start){ label = prevDays - start + i + 1; cls += " faded"; }
      else if(i < start + days){ label = i - start + 1; }
      else { label = i - (start + days) + 1; cls += " faded"; }
      const today = new Date();
      if(y===today.getFullYear() && m===today.getMonth() && label===today.getDate() && !cls.includes("faded")) cls += " today";
      parts.push(`<div class="${cls}">${label}</div>`);
    }
    calGrid.innerHTML = parts.join('');
  }
  prevMth.onclick = ()=>{ view.setMonth(view.getMonth()-1); buildCalendar(view); };
  nextMth.onclick = ()=>{ view.setMonth(view.getMonth()+1); buildCalendar(view); };
  buildCalendar(view);
}
setTimeout(initCalendar, 0);

// ---------- Notifs render ----------
function renderNotifs(){
  const el = document.getElementById('notifList');
  el.innerHTML = notifs.map(n=>`<div class="notif-item"><div class="notif-dot"></div><div style="flex:1;font-weight:700;color:var(--green)">${n.text}</div><div class="notif-time">${n.time}</div></div>`).join('');
}
renderNotifs();

// ---------- User menu (inline in header) ----------
const openProfile = document.getElementById('openProfile');
const userMenu = document.getElementById('userMenu');
openProfile.addEventListener('click', function(e){ e.stopPropagation(); userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block'; });
document.addEventListener('mousedown', function(e){ if(!openProfile.contains(e.target)){ userMenu.style.display = 'none'; } });

// Wire inline menu actions
const profileBtn = document.getElementById('Profile');
const settingsBtn = document.getElementById('OpenSettings');
const logoutBtn = document.getElementById('Logout');
if(profileBtn) profileBtn.addEventListener('click', ()=>{
  // show profile popup if exists, otherwise reuse group popup as fallback
  const pp = document.getElementById('popupProfile') || document.getElementById('popupGroup');
  if(pp){ pp.classList.add('active'); pp.setAttribute('aria-hidden','false'); }
  userMenu.style.display = 'none';
});
if(settingsBtn) settingsBtn.addEventListener('click', ()=>{
  // open WorkHub settings overlay if present, otherwise open invite popup
  const wh = document.getElementById('whSettings');
  if(wh){ wh.style.display = 'block'; }
  else {
    const pa = document.getElementById('popupAddMembers'); if(pa) pa.classList.add('active');
  }
  userMenu.style.display = 'none';
});
if(logoutBtn) logoutBtn.addEventListener('click', ()=>{ alert('Đăng xuất'); userMenu.style.display = 'none'; });

// ---------- Create group popup ----------
const btnAddGroup = document.getElementById('btnAddGroup');
const popupGroup = document.getElementById('popupGroup');
const closeGroupPopup = document.getElementById('closeGroupPopup');
const cancelGroupBtn = document.getElementById('cancelGroupBtn');
btnAddGroup.addEventListener('click', ()=> popupGroup.classList.add('active'));
closeGroupPopup.addEventListener('click', ()=> popupGroup.classList.remove('active'));
cancelGroupBtn.addEventListener('click', ()=> popupGroup.classList.remove('active'));
document.getElementById('groupForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('groupName').value.trim();
  if(!name) return alert('Nhập tên nhóm');
  groups.push({name, leader:'Bạn'});
  renderGroups();
  popupGroup.classList.remove('active');
});

// ---------- Add members popup ----------
const btnAddMember = document.getElementById('btnAddMemberInline');
const popupAdd = document.getElementById('popupAddMembers');
const closeAddPopup = document.getElementById('closeAddPopup');
const autocompleteInput = document.getElementById('autocompleteInput');
const autocompleteList = document.getElementById('autocompleteList');
const selectedList = document.getElementById('selectedList');
const confirmAddBtn = document.getElementById('confirmAddBtn');
let selectedUsers = [];

btnAddMember.addEventListener('click', ()=> popupAdd.classList.add('active'));
closeAddPopup.addEventListener('click', closeAdd);
popupAdd.addEventListener('click', e=> { if(e.target===popupAdd) closeAdd(); });
function closeAdd(){ popupAdd.classList.remove('active'); autocompleteInput.value=''; autocompleteList.style.display='none'; selectedList.innerHTML=''; selectedUsers=[]; }

autocompleteInput.addEventListener('input', function(){
  const val = this.value.trim().toLowerCase();
  if(!val) { autocompleteList.style.display='none'; autocompleteList.innerHTML=''; return; }
  const filtered = usersForInvite.filter(u=> !selectedUsers.some(s=>s.id===u.id) && (u.username.toLowerCase().includes(val) || u.email.toLowerCase().includes(val) || u.name.toLowerCase().includes(val)));
  if(!filtered.length){ autocompleteList.style.display='none'; autocompleteList.innerHTML=''; return; }
  autocompleteList.innerHTML = filtered.map(u=>`<div class="autocomplete-item" data-id="${u.id}"><img src="${u.avatar}" style="width:34px;height:34px;border-radius:50%"><div style="margin-left:6px"><div style="font-weight:700;color:var(--green)">${u.username}</div><div style="font-size:12px;color:var(--muted)">${u.email}</div><div style="font-size:12px;color:var(--muted)">${u.name}</div></div></div>`).join('');
  autocompleteList.style.display='block';
});
autocompleteList.addEventListener('click', e=>{
  let item = e.target;
  while(item && !item.classList.contains('autocomplete-item')) item = item.parentElement;
  if(!item) return;
  const id = Number(item.getAttribute('data-id'));
  const u = usersForInvite.find(x=>x.id===id);
  if(!u) return;
  selectedUsers.push(u);
  renderSelectedUsers();
  autocompleteInput.value=''; autocompleteList.style.display='none';
});
function renderSelectedUsers(){
  selectedList.innerHTML = selectedUsers.map((u,i)=>`<li class="selected-item"><img src="${u.avatar}" style="width:36px;height:36px;border-radius:50%"><div style="flex:1"><div style="font-weight:700">${u.username}</div><div style="font-size:13px;color:var(--muted)">${u.name}</div></div><button class="remove-btn" data-idx="${i}" style="background:none;border:none;font-size:18px;color:#ef4444;cursor:pointer">&times;</button></li>`).join('');
}
selectedList.addEventListener('click', e=>{
  if(e.target.classList.contains('remove-btn')){
    const idx = Number(e.target.getAttribute('data-idx'));
    selectedUsers.splice(idx,1);
    renderSelectedUsers();
  }
});
autocompleteInput.addEventListener('blur', ()=> setTimeout(()=>{ autocompleteList.style.display='none'; },150));
confirmAddBtn.addEventListener('click', ()=>{
  if(!selectedUsers.length) return alert('Vui lòng chọn ít nhất một thành viên!');
  selectedUsers.forEach(u=>{
    if(!members.some(m=>m.name===u.name && m.handle===('@'+u.username))){
      members.push({id: members.length? Math.max(...members.map(m=>m.id))+1:1, name:u.name, handle:'@'+u.username});
    }
  });
  renderMembers();
  alert('Đã mời: \n' + selectedUsers.map(s=>s.name+' ('+s.username+')').join('\n'));
  closeAdd();
});

// ---------- Notifs render (duplicate function removed earlier, keep one) ----------
function renderNotifs(){
  const el = document.getElementById('notifList');
  el.innerHTML = notifs.map(n=>`<div class="notif-item"><div class="notif-dot"></div><div style="flex:1;font-weight:700;color:var(--green)">${n.text}</div><div class="notif-time">${n.time}</div></div>`).join('');
}
renderNotifs();

// init sample messages
addChatMessage('A','Xin chào!');
addChatMessage('B','Chào bạn!');

// popupProfile and whSettings close handlers
const popupProfile = document.getElementById('popupProfile');
const closeProfileBtn = document.getElementById('closeProfileBtn');
if(closeProfileBtn) closeProfileBtn.addEventListener('click', ()=>{ popupProfile.style.display='none'; popupProfile.classList.remove('active'); popupProfile.setAttribute('aria-hidden','true'); });
if(popupProfile) popupProfile.addEventListener('click', (e)=>{ if(e.target === popupProfile) { popupProfile.style.display='none'; popupProfile.setAttribute('aria-hidden','true'); } });

const whOverlay = document.getElementById('whSettings');
const whClose = document.getElementById('whClose');
if(whClose) whClose.addEventListener('click', ()=>{ whOverlay.style.display='none'; });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && whOverlay && whOverlay.style.display === 'block') whOverlay.style.display = 'none'; });

</script>
</body>
</html>
