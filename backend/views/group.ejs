<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>WorkHub Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/frontend/style.css">
</head>

<body>
  <div class="dashboard-frame">
    <!-- HEADER -->
    <div class="dashboard-header" style="margin-top: 0">
      <div class="logo-bar">
        <a href="/" class="site-name">WorkHub</a>
      </div>
      <div class="header-actions actions-cluster">
        <button class="icon-btn" title="Menu" aria-label="Menu">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="3" y1="6" x2="21" y2="6" stroke-width="2" />
            <line x1="3" y1="12" x2="21" y2="12" stroke-width="2" />
            <line x1="3" y1="18" x2="21" y2="18" stroke-width="2" />
          </svg>
        </button>
        <button class="icon-btn" id="btnTheme" title="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi" aria-pressed="false">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="5" stroke-width="2" />
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
              stroke-width="2" />
          </svg>
        </button>
        <button class="icon-btn" id="btnCalendar" title="L·ªãch" aria-label="L·ªãch">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke-width="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6" stroke-width="2"></line>
            <line x1="8" y1="2" x2="8" y2="6" stroke-width="2"></line>
            <line x1="3" y1="10" x2="21" y2="10" stroke-width="2"></line>
          </svg>
        </button>
        <button class="icon-btn" id="btnNotif" title="Th√¥ng b√°o" aria-label="Th√¥ng b√°o">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"></path>
            <path d="M13.73 21a2 2 0 01-3.46 0" stroke-width="2"></path>
          </svg>
        </button>
        <!-- account -->
        <div class="user-account" id="openProfile" title="Account" style="position: relative">
          <div style="position: relative">
            <img id="avatarPreview" name="avatarPath" alt="avatar"
              src="<%= user.avatarPath || '/uploads/default-avatar.png' %>"
              style="width: 32px; height: 32px; border-radius: 50%; background: #cbd5e1; display: flex; align-items: center; justify-content: center;" />
            <span
              style="position: absolute; bottom: 0; right: -2px; width: 10px; height: 10px; background: #22c55e; border-radius: 50%; border: 2px solid var(--surface); display: block;">
            </span>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <span style="font-weight: 700; font-size: 1.08rem; line-height: 1.1; color: var(--text);">
              <%= user.name || 'T√™n ng∆∞·ªùi d√πng' %>
            </span>
            <span style="font-size: 0.97rem; color: var(--text-muted); line-height: 1.1;">
              <%= user.email || 'example.com' %>
            </span>
          </div>
          <svg style="margin-left: 8px" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path d="M6 9l6 6 6-6" />
          </svg>

          <div id="userMenu" style="
                display: none;
                position: absolute;
                top: 48px;
                right: 0;
                min-width: 180px;
                background: var(--surface);
                border-radius: 10px;
                box-shadow: var(--shadow-soft);
                padding: 10px 0;
                z-index: 100;
                border: 1px solid var(--border-color);
              ">
            <button style="
                  width: 100%;
                  background: none;
                  border: none;
                  text-align: left;
                  padding: 10px 18px;
                  font-size: 1rem;
                  color: var(--primary);
                  cursor: pointer;
                " id="Profile">
              Xem th√¥ng tin
            </button>
            <button style="
                  width: 100%;
                  background: none;
                  border: none;
                  text-align: left;
                  padding: 10px 18px;
                  font-size: 1rem;
                  color: var(--primary);
                  cursor: pointer;
                " id="OpenSettings">
              C√†i ƒë·∫∑t ng∆∞·ªùi d√πng
            </button>
            <button style="
                  width: 100%;
                  background: none;
                  border: none;
                  text-align: left;
                  padding: 10px 18px;
                  font-size: 1rem;
                  color: #ef4444;
                  cursor: pointer;
                " id="Logout">
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- POPUP X√ÅC NH·∫¨N ƒêƒÇNG XU·∫§T -->
    <div class="popup-overlay" id="popupLogout" aria-hidden="true">
      <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="logout-title">
        <div class="popup-header" >
          <div id="logout-title" class="popup-title">X√°c nh·∫≠n</div>
          <button class="close-btn" id="closeLogoutBtn" aria-label="ƒê√≥ng">&times;</button>
        </div>
        <div style="margin-top:12px">
          <p>B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?</p>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
            <button class="btn" id="logoutConfirmNo" type="button" style="background:#9e9e9e">H·ªßy</button>
            <button class="btn" id="logoutConfirmYes" type="button" style="background:var(--secondary)">ƒêƒÉng
              xu·∫•t</button>
          </div>
        </div>
      </div>
    </div>

    <!-- BODY -->
    <div class="dashboard-body" id="dashboardBody">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-search">
            <div class="mini-pill">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"></line>
              </svg>
              <input type="text" placeholder="Search" />
            </div>
          </div>
          <div class="sidebar-list" id="groupList"></div>
        </div>

        <!-- N√öT: T·∫†O NH√ìM -->
        <button class="cssbuttons-io-button" id="btnAddGroup" title="T·∫°o nh√≥m">
          T·∫°o nh√≥m
          <div class="icon">
            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" fill="none" />
            </svg>
          </div>
        </button>
      </div>

      <!-- MAIN -->
      <div class="main-content" id="mainContent">
        <!-- POPUP T·∫†O NH√ìM -->
        <div class="popup-overlay" id="popupGroup" aria-hidden="true">
          <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="create-group-title">
            <button class="close-btn" id="closeGroupPopup" aria-label="ƒê√≥ng">
              &times;
            </button>
            <div class="popup-inner-content" style="flex-direction: column; width: 100%">
              <div>
                <div id="create-group-title" class="popup-title">
                  T·∫°o nh√≥m m·ªõi
                </div>
                <form id="groupForm" action="/groups" method="POST" style="
                    display: flex;
                    flex-direction: column;
                    gap: 18px;
                    min-width: 260px;
                  ">
                  <input type="hidden" name="csrf_token" value="" />
                  <div style="display: flex; flex-direction: column; gap: 6px">
                    <label for="groupName" class="form-label" style="font-weight: 600">T√™n nh√≥m</label>
                    <input id="groupName" name="groupName" type="text" required placeholder="Nh·∫≠p t√™n nh√≥m"
                      class="form-input" style="padding: 10px 13px" />
                  </div>
                  <div style="display: flex; justify-content: flex-end; gap: 12px">
                    <button type="button" class="btn" id="cancelGroupBtn" style="background: #9e9e9e">
                      Hu·ª∑
                    </button>
                    <button type="submit" class="btn" id="createGroupBtn">
                      T·∫°o nh√≥m
                    </button>
                  </div>
                </form>
                <!-- javascript hi·ªán c·ª≠a s·ªï t·∫°o nh√≥m -->
                <script>
                  const popupGroup = document.getElementById('popupGroup');
                  // n√∫t ƒë·ªÉ m·ªü popup (d√≤ng 1500)
                  const btnAddGroup = document.getElementById('btnAddGroup');
                  const closeGroupPopup = document.getElementById('closeGroupPopup'); // n√∫t X
                  const cancelGroupBtn = document.getElementById('cancelGroupBtn'); // n√∫t Hu·ª∑

                  // H√†m m·ªü popup
                  function openGroupPopup() {
                    popupGroup.style.display = 'flex';
                    popupGroup.style.alignItems = 'center';
                    popupGroup.style.justifyContent = 'center';
                    popupGroup.style.backdropFilter = 'blur(2px)';
                  }

                  // H√†m ƒë√≥ng popup
                  function closeGroup() {
                    popupGroup.style.display = 'none';
                  }

                  // S·ª± ki·ªán m·ªü popup 
                  if (btnAddGroup) {
                    btnAddGroup.addEventListener('click', openGroupPopup);
                  }

                  // S·ª± ki·ªán ƒë√≥ng popup khi b·∫•m n√∫t X ho·∫∑c Hu·ª∑
                  closeGroupPopup.addEventListener('click', closeGroup);
                  cancelGroupBtn.addEventListener('click', closeGroup);

                  // ƒê√≥ng popup khi click ra ngo√†i ph·∫ßn n·ªôi dung
                  popupGroup.addEventListener('click', function (e) {
                    if (e.target === popupGroup) {
                      closeGroup();
                    }
                  });
                  // ---------------------------------------------------
                  // Load danh s√°ch nh√≥m ƒë√£ tham gia
                  async function loadGroups() {
                    const groupList = document.getElementById('groupList');
                    if (!groupList) return;
                    groupList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">ƒêang t·∫£i...</div>';
                    try {
                      const res = await fetch('/groups/my-groups', { credentials: 'same-origin' });
                      if (!res.ok) throw new Error('L·ªói khi t·∫£i nh√≥m');
                      const groups = await res.json();
                      if (!Array.isArray(groups) || groups.length === 0) {
                        groupList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">B·∫°n ch∆∞a tham gia nh√≥m n√†o.</div>';
                        return;
                      }
                      groupList.innerHTML = groups.map(g => {
                        const leaderName = g.leaderName || 'Kh√¥ng r√µ';
                        return `
                      <div class="group-card" data-id="${g.id}" style="cursor:pointer; border:1px solid #ddd; border-radius:8px; padding:10px 12px; margin:6px 0;">
                        <div class="group-title">${g.groupName}</div>
                        <div class="group-leader">Nh√≥m tr∆∞·ªüng: <span>${leaderName}</span></div>
                      </div>
                      `;
                      }).join('');

                      // Th√™m s·ª± ki·ªán click sau khi render
                      document.querySelectorAll('.group-card').forEach(card => {
                        card.addEventListener('click', () => {
                          const groupId = card.getAttribute('data-id');
                          window.location.href = `/groups/${groupId}`; // render group.ejs t∆∞∆°ng ·ª©ng
                        });
                      });
                    } catch (err) {
                      groupList.innerHTML = '<div style="color:#ef4444;text-align:center;padding:20px;">L·ªói khi t·∫£i danh s√°ch nh√≥m.</div>';
                    }
                  }
                  window.addEventListener('DOMContentLoaded', loadGroups);

                  // X·ª≠ l√Ω submit t·∫°o nh√≥m
                  const groupForm = document.getElementById('groupForm');
                  if (groupForm) {
                    groupForm.addEventListener('submit', async function (e) {
                      e.preventDefault();
                      const groupName = document.getElementById('groupName').value.trim();
                      if (!groupName) return alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m');
                      try {
                        const res = await fetch('/groups', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ groupName }),
                          credentials: 'same-origin'
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'L·ªói t·∫°o nh√≥m');
                        alert('T·∫°o nh√≥m th√†nh c√¥ng!');
                        groupForm.reset();
                        document.getElementById('popupGroup').style.display = 'none';
                        loadGroups();
                      } catch (err) {
                        alert(err.message || 'L·ªói khi t·∫°o nh√≥m');
                      }
                    });
                  }
                </script>
              </div>
            </div>
          </div>
        </div>
        <!-- Trang nh√≥m -->
        <div class="content-task" id="paperArea">
          <div class="chat-wrapper" style="display:flex;flex-direction:column;height:100%">
            <div class="chat-header-bar">
              <div style="display:flex;flex-direction:column">
                <div style="font-weight:800;color:var(--text)">
                  <%= group.groupName %>
                </div>
                <div style="font-size:0.9rem;color:var(--text-muted)">
                  <%= group.memberCount %> th√†nh vi√™n
                </div>
              </div>
              <div style="display:flex;gap:12px">
                <button id="addMemberBtnSmall">
                  + Th√™m th√†nh vi√™n
                </button>
                <button id="createTaskBtnSmall">
                  T·∫°o c√¥ng vi·ªác
                </button>
              </div>
            </div>
            <div id="chatMessages" class="chat-messages">
              <!-- message 
              <div class="msg-row" style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px;">
                <div class="avatar" style="width:44px;height:44px;border-radius:50%;background:#e6f7ed;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">A</div>
                <div class="bubble" style="background:#f6fff6;padding:10px 12px;border-radius:10px;max-width:70%;">
                  <strong>A</strong>
                  <div>Xin ch√†o!</div>
                </div>
              </div>

              
              <div class="msg-row" style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px;">
                <div class="avatar" style="width:44px;height:44px;border-radius:50%;background:#e6f7ed;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">B</div>
                <div class="bubble" style="background:#f6fff6;padding:10px 12px;border-radius:10px;max-width:70%;">
                  <strong>B</strong>
                  <div>Ch√†o b·∫°n!</div>
                </div>
              </div> -->
            </div>

            <!-- input row -->
            <div class="chat-input-row">
              <label for="fileInputCenter" class="attach-circle" title="ƒê√≠nh k√®m" style="margin-right:8px">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M21.44 11.05l-8.49 8.49a5.5 5.5 0 01-7.78 0 5.5 5.5 0 010-7.78l8.49-8.49a3.5 3.5 0 014.95 4.95l-8.49 8.49a1.5 1.5 0 01-2.12-2.12l7.07-7.07"
                    fill="currentColor" />
                </svg>
              </label>
              <input id="fileInputCenter" type="file" style="display:none" />
              <input id="chatInputCenter" placeholder="Nh·∫≠p tin nh·∫Øn...">
              <button id="sendBtnCenter">G·ª≠i</button>
            </div>
          </div>

          <!-- <script>
            (function(){
              var send = document.getElementById('sendBtnCenter');
              var input = document.getElementById('chatInputCenter');
              var fileInput = document.getElementById('fileInputCenter');
              var messages = document.getElementById('chatMessages');

              function appendMessage(label, text){
                var row = document.createElement('div');
                row.className = 'msg-row';
                row.style.display = 'flex'; row.style.gap='12px'; row.style.alignItems='flex-start'; row.style.marginBottom='12px';
                var av = document.createElement('div'); av.style.width='44px'; av.style.height='44px'; av.style.borderRadius='50%'; av.style.background='#e6f7ed'; av.style.display='flex'; av.style.alignItems='center'; av.style.justifyContent='center'; av.style.fontWeight='700'; av.style.color='var(--primary)'; av.textContent = label;
                var bubble = document.createElement('div'); bubble.style.background='#f6fff6'; bubble.style.padding='10px 12px'; bubble.style.borderRadius='10px'; bubble.style.maxWidth='70%';
                bubble.innerHTML = '<strong>'+label+'</strong><div>'+text+'</div>';
                row.appendChild(av); row.appendChild(bubble); messages.appendChild(row); messages.scrollTop = messages.scrollHeight;
              }

              if(send && input){
                send.addEventListener('click', function(){
                  var v = input.value.trim(); if(!v) return; appendMessage('B·∫°n', v); input.value = '';
                });
                input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); send.click(); } });
              }

              if(fileInput){
                document.querySelector('label[for="fileInputCenter"]').addEventListener('click', function(){ fileInput.click(); });
                fileInput.addEventListener('change', function(){ if(fileInput.files[0]){ appendMessage('B·∫°n', 'ƒê√£ g·ª≠i t·ªáp: '+fileInput.files[0].name); } });
              }
            })();
          </script> -->
        </div>
      </div>

      <!-- RIGHT COLUMN: members list -->
      <div class="right-column">
        <div class="right-panel">
          <div class="search-members">
            <input id="memberSearchRight" placeholder="T√¨m ki·∫øm th√†nh vi√™n...">
          </div>
          <div id="membersWrapRight" class="member-list"></div>
          <div id="memberCountRight" style="padding:12px 8px;color:var(--text-muted)"></div>
          <div class="deleteGroup">
            <button type="button" value="X√≥a" style="width: 100%; color: red;">X√≥a nh√≥m</button>
          </div>
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              const deleteBtn = document.querySelector(".deleteGroup button");
              const groupId = "<%= group.id %>";

              if (deleteBtn) {
                deleteBtn.addEventListener("click", async () => {
                  const confirmDelete = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√≥m n√†y kh√¥ng?");
                  if (!confirmDelete) return;

                  try {
                    const res = await fetch(`/groups/${groupId}/delete`, {
                      method: "DELETE",
                      credentials: "same-origin"
                    });

                    const result = await res.json();

                    if (res.ok && result.success) {
                      alert("Nh√≥m ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!");
                      window.location.href = "/"; // quay l·∫°i trang ch·ªß
                    } else {
                      alert((result.error || "Kh√¥ng th·ªÉ x√≥a nh√≥m."));
                    }
                  } catch (err) {
                    console.error(err);
                    alert("L·ªói khi g·ª≠i y√™u c·∫ßu x√≥a nh√≥m.");
                  }
                });
              }
            });
          </script>

        </div>
      </div>


      <!-- member context menu -->
      <div id="memberMenu" class="member-menu" role="menu" aria-hidden="true">
        <div class="menu-item" data-action="view">üëÅÔ∏è Xem th√¥ng tin</div>
        <div class="menu-item" data-action="message">üí¨ Nh·∫Øn tin</div>
        <div class="menu-item" data-action="remove" style="color:#d32f2f">üóëÔ∏è X√≥a th√†nh vi√™n</div>
      </div>

      <!-- javascript load th√†nh vi√™n -->
      <script>
        async function loadMembers() {
          const membersWrap = document.getElementById("membersWrapRight");
          const memberCountRight = document.getElementById("memberCountRight");
          const groupId = "<%= group.id %>";

          membersWrap.innerHTML = '<div style="padding:10px;color:var(--text-muted);text-align:center">ƒêang t·∫£i...</div>';
          try {
            const res = await fetch(`/groups/${groupId}/members`, { credentials: "same-origin" });
            if (!res.ok) throw new Error("L·ªói khi t·∫£i danh s√°ch th√†nh vi√™n");
            const members = await res.json();
            if (members.length === 0) {
              membersWrap.innerHTML = '<div style="padding:10px;color:var(--text-muted);text-align:center">Ch∆∞a c√≥ th√†nh vi√™n n√†o.</div>';
              memberCountRight.textContent = "0 th√†nh vi√™n";
              return;
            }

            membersWrap.innerHTML = members
              .map(
                (m) => `
          <div class="member-item">
            <div class="avatar">
              ${m.avatarPath ? `<img src="${m.avatarPath}" style="width: 32px; height: 32px;object-fit:cover;border-radius:50%;">` : m.name.charAt(0).toUpperCase()}
            </div>
            <div style="flex:1">
              <div style="font-weight:600;color:var(--text)">${m.name}</div>
              <div style="font-size:0.9rem;color:var(--text-muted)">${m.roleInGroup === 'leader' ? 'üëë Tr∆∞·ªüng nh√≥m' : 'üë§ Th√†nh vi√™n'}</div>
            </div>
          </div>`
              )
              .join("");

            memberCountRight.textContent = `${members.length} th√†nh vi√™n`;
          } catch (err) {
            console.error(err);
            membersWrap.innerHTML = '<div style="padding:10px;color:#ef4444;text-align:center">Kh√¥ng th·ªÉ t·∫£i danh s√°ch th√†nh vi√™n.</div>';
          }
        }

        document.addEventListener("DOMContentLoaded", loadMembers);
      </script>


      <!-- RIGHT PANEL STACK -->
      <div class="right-panel-stack" id="rightPanelStack">
        <div class="right-panel half" id="calendarPanel">
          <div class="panel-head">
            <span class="panel-title">
              <svg width="20" height="20" style="vertical-align: middle; margin-right: 6px" fill="none"
                stroke="currentColor">
                <rect x="3" y="4" width="14" height="14" rx="2" stroke-width="2" />
                <line x1="7" y1="2" x2="7" y2="6" stroke-width="2" />
                <line x1="13" y1="2" x2="13" y2="6" stroke-width="2" />
              </svg>
              L·ªãch
            </span>
            <button class="close-panel" id="closeCalendarPanel" title="ƒê√≥ng">
              &times;
            </button>
          </div>
          <div class="right-section" id="calendarPanelContent"></div>
        </div>

        <div class="right-panel half" id="notifPanel">
          <div class="panel-head">
            <span class="panel-title">
              <svg width="20" height="20" style="vertical-align: middle; margin-right: 6px" fill="none"
                stroke="currentColor">
                <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"></path>
                <path d="M13.73 21a2 2 0 01-3.46 0" stroke-width="2"></path>
              </svg>
              Th√¥ng b√°o
            </span>
            <button class="close-panel" id="closeNotifPanel" title="ƒê√≥ng">
              &times;
            </button>
          </div>
          <div class="right-section" id="notifPanelContent"></div>
        </div>
      </div>

      <!-- POPUP TH√îNG TIN T√ÄI KHO·∫¢N -->
      <div class="popup-overlay" id="popupProfile" aria-hidden="true">
        <div class="popup-content" style="width: 420px; max-width: 95vw" role="dialog" aria-modal="true"
          aria-labelledby="profile-title">
          <div class="popup-header"
            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;">
            <div id="profile-title" class="popup-title" style="font-size: 23px">Th√¥ng tin t√†i kho·∫£n</div>
            <button class="close-btn" id="closeProfileBtn" style="font-size: 28px" aria-label="ƒê√≥ng">&times;</button>
            <!-- javascript ƒë√≥ng popup hi·ªán th√¥ng tin -->
            <script>
              // L·∫•y ph·∫ßn t·ª≠ popup v√† n√∫t ƒë√≥ng
              const popupProfile = document.getElementById('popupProfile');
              const closeProfileBtn = document.getElementById('closeProfileBtn');

              // Khi b·∫•m n√∫t X th√¨ ·∫©n popup
              closeProfileBtn.addEventListener('click', function () {
                popupProfile.style.display = 'none';
              });
            </script>
          </div>

          <!-- FORM -->
          <form class="profile-form" id="profileForm" action="/info" method="POST" enctype="multipart/form-data"
            style=" display: flex; flex-direction: column; gap: 13px; margin-bottom: 22px;">
            <!-- Background + Avatar upload -->
            <div class="profile-hero">
              <div class="background">
                <img id="bgPreview" name="backgroundPath" alt="background"
                  src="<%= user.backgroundPath || '/uploads/default-bg.png' %>" />
                <label class="bg-upload">
                  Thay ƒë·ªïi
                  <input type="file" id="backgroundInput" name="background" accept="image/*" style="display: none"
                    onchange="previewImage(event, 'bgPreview')" />
                </label>
              </div>
              <div class="avatar">
                <img id="avatarPreview" name="avatarPath" alt="avatar"
                  src="<%= user.avatarPath || '/uploads/default-avatar.png' %>" />
                <label class="avatar-upload">
                  ‚úé
                  <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none"
                    onchange="previewImage(event, 'avatarPreview')" />
                </label>
              </div>

              <!-- javascript thay ƒë·ªïi avatar v√† background -->
              <script>
                // Xem tr∆∞·ªõc ·∫£nh
                function previewImage(event, previewId) {
                  const reader = new FileReader();
                  reader.onload = () => {
                    document.getElementById(previewId).src = reader.result;
                  };
                  reader.readAsDataURL(event.target.files[0]);
                }
              </script>
              <!-- Th√¥ng tin t√†i  kho·∫£n -->
              <div>
                <input class="name" type="text" name="name" value="<%= user.name || '' %>" readonly>
              </div>
            </div>

            <input type="hidden" name="csrf_token" value="" />
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="username" style="width: 110px">T√™n t√†i kho·∫£n</label>
              <input class="form-input" name="username" type="text" value="<%= user.username %>" readonly id="username"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="email" style="width: 110px">Email</label>
              <input class="form-input" name="email" type="email" value="<%= user.email %>" readonly id="email"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="phone" style="width: 110px">S·ªë ƒëi·ªán tho·∫°i</label>
              <input class="form-input" name="phoneNumber" type="text" value="<%= user.phoneNumber || '' %>" readonly
                id="phone" style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="dob" style="width: 110px">Ng√†y sinh</label>
              <input class="form-input" name="dob" type="date"
                value="<%= user.dob ? new Date(user.dob).toISOString().split('T')[0] : '' %>" readonly id="dob"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="gender" style="width: 110px">Gi·ªõi t√≠nh</label>
              <select class="form-input" name="gender" id="gender" disabled style="flex: 1; padding: 10px 13px">
                <option value="">--Ch·ªçn--</option>
                <option value="male" <%=user.gender==='male' ? 'selected' : '' %>>Nam</option>
                <option value="female" <%=user.gender==='female' ? 'selected' : '' %>>N·ªØ</option>
                <option value="other" <%=user.gender==='other' ? 'selected' : '' %>>Kh√°c</option>
              </select>
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="address" style="width: 110px">ƒê·ªãa ch·ªâ</label>
              <input class="form-input" name="address" type="text" value="<%= user.address || '' %>" readonly
                id="address" style="flex: 1; padding: 10px 13px" />
            </div>
          </form>
          <!------------------------------------------- POPUP X√ÅC NH·∫¨N ------------------------------------------>
          <div class="confirm-overlay" id="confirmOverlay"
            style="display:none; position: fixed; inset:0; background: rgba(0,0,0,0.3); align-items: center; justify-content: center; z-index: 1100;">
            <div class="confirm-box"
              style="background:white; padding:20px 25px; border-radius:10px; text-align:center;">
              <p style="margin-bottom:15px; font-size:17px;">B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?</p>
              <div style="display:flex; justify-content:center; gap:10px;">
                <button id="confirmYes" class="btn" style="background:#4CAF50; color:white; padding:6px 14px;">X√°c
                  nh·∫≠n</button>
                <button id="confirmNo" class="btn"
                  style="background:#f44336; color:white; padding:6px 14px;">H·ªßy</button>
              </div>
            </div>
          </div>
          <!------------------------------------------------------------------------------------------------------>
          <script>
            const profileForm = document.getElementById('profileForm');
            const avatarInput = document.getElementById('avatarInput');
            const backgroundInput = document.getElementById('backgroundInput');
            const confirmOverlay = document.getElementById('confirmOverlay');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            //const popupProfile = document.getElementById('popupProfile');

            // Khi ch·ªçn ·∫£nh m·ªõi -> hi·ªán popup x√°c nh·∫≠n
            avatarInput.addEventListener('change', handleImageChange);
            backgroundInput.addEventListener('change', handleImageChange);

            function handleImageChange(event) {
              const file = event.target.files[0];
              if (!file) return;
              previewImage(event, event.target.id === 'avatarInput' ? 'avatarPreview' : 'bgPreview');
              confirmOverlay.style.display = 'flex';
            }

            // H√†m xem tr∆∞·ªõc ·∫£nh
            function previewImage(event, previewId) {
              const file = event.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (e) => {
                document.getElementById(previewId).src = e.target.result;
              };
              reader.readAsDataURL(file);
            }

            // Khi b·∫•m ‚ÄúX√°c nh·∫≠n‚Äù => submit form + ƒë√≥ng popup
            confirmYes.addEventListener('click', () => {
              confirmOverlay.style.display = 'none';
              profileForm.submit(); // g·ª≠i form ƒë·ªÉ backend l∆∞u v√†o DB
              popupProfile.style.display = 'none'; // ƒë√≥ng popup th√¥ng tin
            });

            // Khi b·∫•m ‚ÄúH·ªßy‚Äù => ƒë√≥ng popup x√°c nh·∫≠n
            confirmNo.addEventListener('click', () => {
              confirmOverlay.style.display = 'none';
              avatarInput.value = "";
              backgroundInput.value = "";
            });
          </script>

        </div>
      </div>

      <!-- ========== WORKHUB SETTINGS OVERLAY ========== -->
      <div id="whSettings" class="wh-settings" aria-hidden="true">
        <!-- Sidebar c√†i ƒë·∫∑t -->
        <div class="wh-wrap">
          <aside class="wh-side">
            <div class="wh-search"><input placeholder="T√¨m ki·∫øm..." /></div>
            <div class="wh-group">C√ÄI ƒê·∫∂T NG∆Ø·ªúI D√ôNG</div>
            <nav class="wh-nav">
              <button class="wh-nav-item wh-active" data-view="account">
                T√†i Kho·∫£n C·ªßa T√¥i
              </button>
              <!-- ch∆∞a nghƒ© ra c√†i ƒë·∫∑t g√¨ kh√°c -->
            </nav>
            <div class="wh-group">C√ÄI ƒê·∫∂T TRANG WEB</div>
            <nav class="wh-nav">
              <button></button>
              <!-- ch∆∞a nghƒ© ra c√†i ƒë·∫∑t g√¨ kh√°c -->
            </nav>
          </aside>

          <main class="wh-main">
            <header class="wh-topbar">
              <div class="wh-title">T√†i Kho·∫£n C·ªßa T√¥i</div>
              <button class="wh-btn wh-primary" id="whClose" title="ESC">
                ƒê√≥ng
              </button>
            </header>
            <!-- Th√¥ng tin t√†i kho·∫£n ------------------------------------------------------------>
            <form class="wh-card" action="/info" method="post" id="settingInfoAccount">
              <div class="wh-row">
                <div>
                  <div class="wh-label">T√™n hi·ªÉn th·ªã</div>
                  <input class="form-input" type="text" name="name" value="<%= user.name || '' %>" readonly
                    style="flex: 1; padding: 10px 13px">
                </div>
              </div>
              <div class="wh-row">
                <div>
                  <div class="wh-label">T√™n ƒëƒÉng nh·∫≠p</div>
                  <input class="form-input" name="username" type="text" value="<%= user.username %>" readonly
                    id="username" style="flex: 1; padding: 10px 13px" />
                </div>
              </div>
              <div class="wh-row">
                <div>
                  <div class="wh-label">Email</div>
                  <input class="form-input" name="email" type="email" value="<%= user.email %>" readonly id="email"
                    style="flex: 1; padding: 10px 13px" />
                </div>
              </div>
              <div class="wh-row">
                <div>
                  <div class="wh-label">S·ªë ƒêi·ªán Tho·∫°i</div>
                  <input class="form-input" name="phoneNumber" type="text" value="<%= user.phoneNumber || '' %>"
                    readonly id="phone" style="flex: 1; padding: 10px 13px" />
                </div>
              </div>
              <div class="wh-row">
                <div>
                  <div class="wh-label">Ng√†y sinh</div>
                  <input class="form-input" name="dob" type="date"
                    value="<%= user.dob ? new Date(user.dob).toISOString().split('T')[0] : '' %>" readonly id="dob"
                    style="flex: 1; padding: 10px 13px" />
                </div>
              </div>
              <div class="wh-row">
                <div>
                  <div class="wh-label">Gi·ªõi t√≠nh</div>
                  <select class="form-input" name="gender" id="gender" disabled style="flex: 1; padding: 10px 13px">
                    <option value="">--Ch·ªçn--</option>
                    <option value="male" <%=user.gender==='male' ? 'selected' : '' %>>Nam</option>
                    <option value="female" <%=user.gender==='female' ? 'selected' : '' %>>N·ªØ</option>
                    <option value="other" <%=user.gender==='other' ? 'selected' : '' %>>Kh√°c</option>
                  </select>
                </div>
              </div>
              <div class="wh-row">
                <div>
                  <div class="wh-label">ƒê·ªãa ch·ªâ</div>
                  <input class="form-input" name="address" type="text" value="<%= user.address || '' %>" readonly
                    id="address" style="flex: 1; padding: 10px 13px" />
                </div>
              </div>
              <div class="wh-btnEditProfile" style="margin-top: 10px;">
                <button class="btn" type="button" id="editProfileBtn" style="background: var(--secondary)">S·ª≠a</button>
                <button class="btn" type="submit" id="saveProfileBtn"
                  style="display: none; background: var(--secondary)">X√°c nh·∫≠n</button>
              </div>
              <!-- javascript s·ª≠a th√¥ng tin -->
              <script>
                const editBtn = document.getElementById("editProfileBtn");
                const saveBtn = document.getElementById("saveProfileBtn");

                editBtn.addEventListener("click", () => {
                  // ·∫®n n√∫t "S·ª≠a"
                  editBtn.style.display = "none";

                  // Hi·ªán n√∫t "X√°c nh·∫≠n"
                  saveBtn.style.display = "inline-block";

                  // M·ªü kh√≥a c√°c input (tr·ª´ username v√† email)
                  document.querySelectorAll("input[readonly], select[disabled]").forEach(el => {
                    const fieldName = el.getAttribute("name");
                    if (fieldName !== "username" && fieldName !== "email") {
                      el.removeAttribute("readonly");
                      el.removeAttribute("disabled");
                      el.style.background = "#fff";
                    }
                  });
                });

                // Khi b·∫•m "X√°c nh·∫≠n" th√¨ ƒë·ªïi l·∫°i n√∫t "S·ª≠a"
                saveBtn.addEventListener("click", () => {
                  editBtn.style.display = "inline-block";
                  saveBtn.style.display = "none";
                });
              </script>
            </form>
            <!-- ----------------------------------------------------------------------------------------- -->
            <div class="wh-tabs">
              <button class="wh-tab wh-active" data-tab="security">
                B·∫£o m·∫≠t
              </button>
              <button class="wh-tab" data-tab="status">Tr·∫°ng th√°i</button>
            </div>
            <div class="wh-panel wh-show" data-tab="security">
              <h3 class="wh-section">M·∫≠t Kh·∫©u v√† X√°c Th·ª±c</h3>
              <div class="wh-card">
                <div class="wh-row wh-between">
                  <div>
                    <div class="wh-t">ƒê·ªïi M·∫≠t Kh·∫©u</div>
                    <div class="wh-sub">
                      C·∫≠p nh·∫≠t m·∫≠t kh·∫©u ƒë·ªÉ b·∫£o v·ªá t√†i kho·∫£n.
                    </div>
                  </div>
                  <button class="wh-btn wh-primary">ƒê·ªïi M·∫≠t Kh·∫©u</button>
                </div>
                <hr style="border: 0; border-top: 1px solid var(--border-color)" />
                <div class="wh-row wh-between">
                  <div>
                    <div class="wh-t">·ª®ng D·ª•ng X√°c Th·ª±c</div>
                    <div class="wh-sub">
                      Th√™m l·ªõp b·∫£o m·∫≠t b·ªï sung khi ƒëƒÉng nh·∫≠p.
                    </div>
                  </div>
                  <button class="wh-btn wh-primary">
                    B·∫≠t ·ª®ng D·ª•ng X√°c Th·ª±c
                  </button>
                </div>
                <hr style="border: 0; border-top: 1px solid var(--border-color)" />
                <div class="wh-row wh-between">
                  <div>
                    <div class="wh-t">M√£ b·∫£o m·∫≠t</div>
                    <div class="wh-sub">
                      T·∫°o m√£ d·ª± ph√≤ng ƒë·ªÉ ƒëƒÉng nh·∫≠p an to√†n.
                    </div>
                  </div>
                  <button class="wh-btn wh-secondary">
                    ƒêƒÉng k√Ω M√£ B·∫£o M·∫≠t
                  </button>
                </div>
              </div>
              <div class="wh-card wh-danger-zone">
                <h4 class="wh-section">Ng·ª´ng S·ª≠ D·ª•ng T√†i Kho·∫£n</h4>
                <div class="wh-row" style="gap: 10px">
                  <button class="wh-btn wh-danger">
                    V√¥ Hi·ªáu H√≥a T√†i Kho·∫£n
                  </button>
                  <button class="wh-btn wh-outline">X√≥a T√†i Kho·∫£n</button>
                </div>
              </div>
            </div>
            <div class="wh-panel" data-tab="status">
              <div class="wh-card">
                <div class="wh-row wh-between">
                  <div>
                    <div class="wh-t">Tr·∫°ng th√°i t√†i kho·∫£n</div>
                    <div class="wh-sub">T√†i kho·∫£n ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</div>
                  </div>
                  <span class="wh-pill-ok">ƒêang ho·∫°t ƒë·ªông</span>
                </div>
              </div>
            </div>
          </main>
        </div>
      </div>
      <!-- ========== /WORKHUB SETTINGS OVERLAY ========== -->
    </div>

    <script>
      // ===== CONFIG =====
      const USE_FETCH = true;
      const API = {
        createGroup: "/groups",
        updateProfile: "/api/profile/update",
      };

      // Xem tr∆∞·ªõc h√¨nh (background/avatar)
      function previewImage(evt, targetId) {
        const file = evt.target.files?.[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        const img = document.getElementById(targetId);
        if (img) {
          img.src = url;
        }
      }

      // Create-group UI removed. The sidebar button opens addmembers.html in a new tab.

      // ===== Theme =====
      const THEME_KEY = "workhub-theme";
      const themeBtn = document.getElementById("btnTheme");
      const themeIcon = document.getElementById("themeIcon");

      function getPreferredTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved === "light" || saved === "dark") return saved;
        return window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }
      function applyTheme(t) {
        document.documentElement.setAttribute("data-theme", t);
        themeBtn.title =
          t === "dark" ? "Chuy·ªÉn sang s√°ng" : "Chuy·ªÉn sang t·ªëi";
        themeBtn.setAttribute("aria-pressed", t === "dark");
        themeIcon.innerHTML =
          t === "dark"
            ? `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"/>`
            : `<circle cx="12" cy="12" r="5" stroke-width="2"/> 
                 <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-width="2"/>`;
      }
      function toggleTheme() {
        const current =
          document.documentElement.getAttribute("data-theme") || "light";
        const next = current === "dark" ? "light" : "dark";
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      }
      applyTheme(getPreferredTheme());
      themeBtn.addEventListener("click", toggleTheme);

      // Tabs (toolbar)
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });

      // Right panels
      const notifPanel = document.getElementById("notifPanel");
      const notifPanelContent = document.getElementById("notifPanelContent");
      const calendarPanel = document.getElementById("calendarPanel");
      const calendarPanelContent = document.getElementById(
        "calendarPanelContent"
      );
      const closeNotifPanel = document.getElementById("closeNotifPanel");
      const closeCalendarPanel =
        document.getElementById("closeCalendarPanel");
      const btnNotif = document.getElementById("btnNotif");
      const btnCalendar = document.getElementById("btnCalendar");

      let panelOrder = [];
      function showPanel(panel) {
        if (panelOrder.includes(panel)) {
          closePanel(panel);
          return;
        }
        panelOrder = [panel, ...panelOrder];
        if (panelOrder.length > 2) panelOrder = panelOrder.slice(0, 2);

        notifPanel.classList.remove("top", "bottom", "show");
        calendarPanel.classList.remove("top", "bottom", "show");

        function renderNotif() {
          notifPanelContent.innerHTML = `
            <div class="notif-list">
              <div class="notif-item"><div class="notif-dot"></div>N·ªôi dung th√¥ng b√°o</div>
              <div class="notif-item"><div class="notif-dot"></div>N·ªôi dung th√¥ng b√°o</div>
              <div class="notif-item"><div class="notif-dot"></div>N·ªôi dung th√¥ng b√°o</div>
              <div class="notif-item"><div class="notif-dot"></div>N·ªôi dung th√¥ng b√°o</div>
            </div>
          `;
        }
        function renderCalendar() {
          calendarPanelContent.innerHTML = `
            <div class="calendar-card" id="calendarCard">
              <div class="calendar-head">
                <div>
                  <div class="calendar-title" id="titleDay">H√¥m nay</div>
                  <div class="calendar-sub" id="subMonth"></div>
                </div>
                <div>
                  <button class="btn" id="prevMth">‚óÄ</button>
                  <button class="btn" id="nextMth">‚ñ∂</button>
                </div>
              </div>
              <div class="calendar-grid" id="calGrid"></div>
            </div>
          `;
          setTimeout(initCalendar, 0);
        }

        if (panelOrder.length === 1) {
          if (panelOrder[0] === "notif") {
            notifPanel.classList.add("show", "top");
            renderNotif();
          } else {
            calendarPanel.classList.add("show", "top");
            renderCalendar();
          }
        } else {
          if (panelOrder[0] === "notif" && panelOrder[1] === "calendar") {
            notifPanel.classList.add("show", "top");
            calendarPanel.classList.add("show", "bottom");
            renderNotif();
          } else {
            calendarPanel.classList.add("show", "top");
            notifPanel.classList.add("show", "bottom");
            renderCalendar();
          }
        }
      }
      function closePanel(panel) {
        panelOrder = panelOrder.filter((p) => p !== panel);
        notifPanel.classList.remove("top", "bottom", "show");
        calendarPanel.classList.remove("top", "bottom", "show");
        if (panelOrder.length === 1) {
          if (panelOrder[0] === "notif") {
            notifPanel.classList.add("show", "top");
          } else {
            calendarPanel.classList.add("show", "top");
          }
        }
      }
      btnNotif.onclick = () => showPanel("notif");
      btnCalendar.onclick = () => showPanel("calendar");
      closeNotifPanel &&
        (closeNotifPanel.onclick = () => closePanel("notif"));
      closeCalendarPanel &&
        (closeCalendarPanel.onclick = () => closePanel("calendar"));
      document.addEventListener("mousedown", (e) => {
        if (
          notifPanel.classList.contains("show") &&
          !notifPanel.contains(e.target) &&
          !btnNotif.contains(e.target)
        )
          closePanel("notif");
        if (
          calendarPanel.classList.contains("show") &&
          !calendarPanel.contains(e.target) &&
          !btnCalendar.contains(e.target)
        )
          closePanel("calendar");
      });

      function initCalendar() {
        const calGrid = document.getElementById("calGrid");
        const titleDay = document.getElementById("titleDay");
        const subMonth = document.getElementById("subMonth");
        const prevMth = document.getElementById("prevMth");
        const nextMth = document.getElementById("nextMth");

        let view = new Date();
        function headText(d) {
          return new Intl.DateTimeFormat("vi-VN", {
            weekday: "short",
            month: "short",
            day: "2-digit",
          }).format(d);
        }
        function buildCalendar(date) {
          const y = date.getFullYear(),
            m = date.getMonth();
          titleDay.textContent = headText(new Date());
          subMonth.textContent = new Intl.DateTimeFormat("vi-VN", {
            month: "long",
            year: "numeric",
          })
            .format(new Date(y, m, 1))
            .toUpperCase();
          const first = new Date(y, m, 1);
          const start = (first.getDay() + 6) % 7; // Monday first
          const days = new Date(y, m + 1, 0).getDate();
          const prevDays = new Date(y, m, 0).getDate();
          const parts = [];
          ["T2", "T3", "T4", "T5", "T6", "T7", "CN"].forEach((d) =>
            parts.push(`<div class="dow">${d}</div>`)
          );
          for (let i = 0; i < 42; i++) {
            let label,
              cls = "cell";
            if (i < start) {
              label = prevDays - start + i + 1;
              cls += " faded";
            } else if (i < start + days) {
              label = i - start + 1;
            } else {
              label = i - (start + days) + 1;
              cls += " faded";
            }
            const today = new Date();
            if (
              y === today.getFullYear() &&
              m === today.getMonth() &&
              label === today.getDate() &&
              !cls.includes("faded")
            )
              cls += " today";
            parts.push(`<div class="${cls}">${label}</div>`);
          }
          calGrid.innerHTML = parts.join("");
        }
        prevMth.addEventListener("click", () => {
          view.setMonth(view.getMonth() - 1);
          buildCalendar(view);
        });
        nextMth.addEventListener("click", () => {
          view.setMonth(view.getMonth() + 1);
          buildCalendar(view);
        });
        buildCalendar(view);
      }

      // ===== Account menu & profile popup =====
      const openProfile = document.getElementById("openProfile");
      const userMenu = document.getElementById("userMenu");
      openProfile.addEventListener("click", function (e) {
        e.stopPropagation();
        userMenu.style.display =
          userMenu.style.display === "block" ? "none" : "block";
      });
      document.addEventListener("mousedown", function (e) {
        if (!openProfile.contains(e.target)) {
          userMenu.style.display = "none";
        }
      });
      document.getElementById("Profile").onclick = function () {
        document.getElementById("popupProfile").style.display = "flex";
        document
          .getElementById("popupProfile")
          .setAttribute("aria-hidden", "false");
        userMenu.style.display = "none";
      };

      // ===== WORKHUB SETTINGS (m·ªü/ƒë√≥ng) =====
      const whOverlay = document.getElementById("whSettings");
      const whBtnOpen = document.getElementById("OpenSettings");
      const whBtnClose = document.getElementById("whClose");

      if (whBtnOpen) {
        whBtnOpen.addEventListener("click", () => {
          whOverlay.style.display = "block";
          if (userMenu) userMenu.style.display = "none";
        });
      }
      if (whBtnClose) {
        whBtnClose.addEventListener("click", () => {
          whOverlay.style.display = "none";
        });
      }
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && whOverlay.style.display === "block") {
          whOverlay.style.display = "none";
        }
      });

      // Tabs trong trang c√†i ƒë·∫∑t
      document.querySelectorAll(".wh-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".wh-tab")
            .forEach((t) => t.classList.remove("wh-active"));
          document
            .querySelectorAll(".wh-panel")
            .forEach((p) => p.classList.remove("wh-show"));
          tab.classList.add("wh-active");
          document
            .querySelector(`.wh-panel[data-tab="${tab.dataset.tab}"]`)
            ?.classList.add("wh-show");
        });
      });

      // Sidebar highlight
      document.querySelectorAll(".wh-nav-item").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".wh-nav-item")
            .forEach((b) => b.classList.remove("wh-active"));
          btn.classList.add("wh-active");
        });
      });
      //ƒêƒÉng xu·∫•t v·ªõi h·ªôp tho·∫°i x√°c nh·∫≠n
      const logoutBtn = document.getElementById("Logout");
      const logoutConfirm = document.getElementById("popupLogout");
      const logoutConfirmYes = document.getElementById("logoutConfirmYes");
      const logoutConfirmNo = document.getElementById("logoutConfirmNo");

      logoutBtn && logoutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (logoutConfirm) {
          logoutConfirm.classList.add("active");
          logoutConfirm.setAttribute("aria-hidden", "false");
        } else {
          // chuy·ªÉn h∆∞·ªõng
          window.location.href = "/auth/logout";
        }
        // ·∫©n user menu
        if (userMenu) userMenu.style.display = "none";
      });

      // confirm
      logoutConfirmYes && logoutConfirmYes.addEventListener("click", () => {
        window.location.href = "/auth/logout";
      });
      logoutConfirmNo && logoutConfirmNo.addEventListener("click", () => {
        if (logoutConfirm) {
          logoutConfirm.classList.remove("active");
          logoutConfirm.setAttribute("aria-hidden", "true");
        }
      });
      const closeLogoutBtn = document.getElementById("closeLogoutBtn");
      closeLogoutBtn && closeLogoutBtn.addEventListener("click", () => {
        if (logoutConfirm) {
          logoutConfirm.classList.remove("active");
          logoutConfirm.setAttribute("aria-hidden", "true");
        }
      });

      // Nh·∫•n X ho·∫∑c click ra ngo√†i ƒë·ªÉ tho√°t
      if (logoutConfirm) {
        logoutConfirm.addEventListener("click", (e) => {
          if (e.target === logoutConfirm) {
            logoutConfirm.classList.remove("active");
            logoutConfirm.setAttribute("aria-hidden", "true");
          }
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && logoutConfirm.classList.contains("active")) {
            logoutConfirm.classList.remove("active");
            logoutConfirm.setAttribute("aria-hidden", "true");
          }
        });
      }
    </script>
  </div>
</body>

</html>