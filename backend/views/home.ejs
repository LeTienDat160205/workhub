<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>WorkHub Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/frontend/style.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body onload="loadTasks()">
  <!-- Popup th√¥ng b√°o -->
  <div id="notificationPopup" style="
        display:none;
        position:fixed;
        top:80px;
        right:20px;
        width:380px;
        background:white;
        border-radius:12px;
        box-shadow:0 6px 20px rgba(0,0,0,0.25);
        z-index:9999;
        overflow:hidden;
     ">

    <div style="background:white; width:100%; border-radius:12px;
                box-shadow:0 6px 20px rgba(0,0,0,0.25); padding:20px;">

      <h3>Th√¥ng b√°o</h3>

      <div class="notif-content" style="max-height:300px;overflow-y:auto;margin-top:10px;">
        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c JS load v√†o ƒë√¢y -->
      </div>

      <button id="closePopupBtn"
        style="margin-top:16px;padding:8px 12px;background:#333;color:white;border:none;border-radius:6px;">
        ƒê√≥ng
      </button>


    </div>
  </div>


  <div id="toast-container"></div>
  <div class="dashboard-frame">
    <!-- HEADER -->
    <div class="dashboard-header" style="margin-top: 0">
      <div class="logo-bar">
        <a href="/" class="site-name"
          style="text-decoration: none; font-size: 35px; font-weight: 900; letter-spacing: 1.5px">WorkHub</a>
      </div>
      <div class="header-actions actions-cluster">
        <button class="icon-btn" title="Menu" aria-label="Menu">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <line x1="3" y1="6" x2="21" y2="6" stroke-width="2" />
            <line x1="3" y1="12" x2="21" y2="12" stroke-width="2" />
            <line x1="3" y1="18" x2="21" y2="18" stroke-width="2" />
          </svg>
        </button>
        <button class="icon-btn" id="btnTheme" title="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi" aria-pressed="false">
          <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="5" stroke-width="2" />
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
              stroke-width="2" />
          </svg>
        </button>
        <button class="icon-btn" id="btnCalendar" title="L·ªãch" aria-label="L·ªãch">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke-width="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6" stroke-width="2"></line>
            <line x1="8" y1="2" x2="8" y2="6" stroke-width="2"></line>
            <line x1="3" y1="10" x2="21" y2="10" stroke-width="2"></line>
          </svg>
        </button>
        <button class="icon-btn" id="notifbutton" title="Th√¥ng b√°o" aria-label="Th√¥ng b√°o">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"></path>
            <path d="M13.73 21a2 2 0 01-3.46 0" stroke-width="2"></path>
          </svg>


        </button>




        <!-- account -->
        <div class="user-account" id="openProfile" title="Account" style="position: relative">
          <div style="position: relative">
            <div id="avatarWrapper"
              style="width: 32px; height: 32px; border-radius: 50%; background: #cbd5e1;  display: flex; align-items: center; justify-content: center;">
              <img id="avatarPreview" name="avatarPath" alt="avatar"
                src="<%= user.avatarPath || '/uploads/default-avatar.png' %>"
                style="width: 32px; height: 32px; border-radius: 50%; background: #cbd5e1; display: flex; align-items: center; justify-content: center;" />
              <span
                style="position: absolute; bottom: 0; right: -2px; width: 10px; height: 10px; background: #22c55e; border-radius: 50%; border: 2px solid var(--surface); display: block;">
              </span>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; align-items: flex-start;">
            <span style="font-weight: 700; font-size: 1.08rem; line-height: 1.1; color: var(--text);">
              <%= user.name || 'T√™n ng∆∞·ªùi d√πng' %>
            </span>
            <span style="font-size: 0.97rem; color: var(--text-muted); line-height: 1.1;">
              <%= user.email || '@example.com' %>
            </span>
          </div>
          <svg style="margin-left: 8px" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <path d="M6 9l6 6 6-6" />
          </svg>

          <div id="userMenu" style="
                display: none;
                position: absolute;
                top: 48px;
                right: 0;
                min-width: 180px;
                background: var(--surface);
                border-radius: 10px;
                box-shadow: var(--shadow-soft);
                padding: 10px 0;
                z-index: 100;
                border: 1px solid var(--border-color);
              ">
            <button style="
                  width: 100%;
                  background: none;
                  border: none;
                  text-align: left;
                  padding: 10px 18px;
                  font-size: 1rem;
                  color: var(--primary);
                  cursor: pointer;
                " id="Profile">
              Xem th√¥ng tin
            </button>
            <button style="
                  width: 100%;
                  background: none;
                  border: none;
                  text-align: left;
                  padding: 10px 18px;
                  font-size: 1rem;
                  color: var(--primary);
                  cursor: pointer;
                " id="OpenSettings">
              C√†i ƒë·∫∑t ng∆∞·ªùi d√πng
            </button>
            <button style="
                  width: 100%;
                  background: none;
                  border: none;
                  text-align: left;
                  padding: 10px 18px;
                  font-size: 1rem;
                  color: #ef4444;
                  cursor: pointer;
                " id="Logout">
              ƒêƒÉng xu·∫•t
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- X·ª¨ L√ù AVATAR -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const avatarPreview = document.getElementById("avatarPreview");
        const avatarWrapper = document.getElementById("avatarWrapper") || avatarPreview.parentElement;

        const userName = "<%= user.name || 'User' %>";
        const avatarSrc = "<%= user.avatarPath || '' %>";

        // N·∫øu ng∆∞·ªùi d√πng ch∆∞a c√≥ ·∫£nh avatar th·∫≠t
        if (!avatarSrc || avatarSrc.includes("default-avatar")) {
          // ·∫®n ·∫£nh th·∫≠t
          avatarPreview.style.display = "none";

          // T·∫°o avatar ch·ªØ c√°i ƒë·∫ßu ti√™n
          const initial = userName.trim() ? userName.trim().charAt(0).toUpperCase() : "?";

          // Ki·ªÉm tra m√†u trong localStorage
          const colorKey = `avatarColor_${userName}`;
          let bgColor = localStorage.getItem(colorKey);

          // N·∫øu ch∆∞a c√≥ th√¨ random 1 l·∫ßn
          if (!bgColor) {
            const colors = ["#f87171", "#fb923c", "#facc15", "#4ade80", "#60a5fa", "#a78bfa", "#f472b6"];
            bgColor = colors[Math.floor(Math.random() * colors.length)];
            localStorage.setItem(colorKey, bgColor);
          }

          // T·∫°o avatar b·∫±ng ch·ªØ
          const letterAvatar = document.createElement("div");
          letterAvatar.textContent = initial;
          letterAvatar.style.cssText = `width: 100%;height: 100%;border-radius: 50%;background: ${bgColor};color: white;font-weight: 600; font-size: 1.2rem;display: flex;align-items: center;justify-content: center;`;
          avatarWrapper.appendChild(letterAvatar);
        } else {
          // C√≥ ·∫£nh th·∫≠t th√¨ hi·ªÉn th·ªã ·∫£nh
          avatarPreview.src = avatarSrc;
          avatarPreview.style.display = "block";
        }

        // ====== Khi ng∆∞·ªùi d√πng ch·ªçn ·∫£nh m·ªõi ======
        const avatarInput = document.getElementById("avatarInput");
        if (avatarInput) {
          avatarInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
              // N·∫øu ƒë√£ c√≥ avatar ch·ªØ th√¨ x√≥a
              const existingLetter = avatarWrapper.querySelector("div");
              if (existingLetter) existingLetter.remove();

              // Hi·ªÉn th·ªã ·∫£nh m·ªõi
              avatarPreview.src = reader.result;
              avatarPreview.style.display = "block";
            };
            reader.readAsDataURL(file);
          });
        }
      });
    </script>

    <!-- POPUP X√ÅC NH·∫¨N ƒêƒÇNG XU·∫§T -->
    <div class="popup-overlay" id="popupLogout" aria-hidden="true">
      <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="logout-title">
        <div class="popup-header">
          <div id="logout-title" class="popup-title" style="color: red;">ƒêƒÉng xu·∫•t</div>
          <button class="close-btn" id="closeLogoutBtn" aria-label="ƒê√≥ng">&times;</button>
        </div>
        <div style="margin-top:12px">
          <p>B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?</p>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
            <button class="btn" id="logoutConfirmNo" type="button" style="background:#9e9e9e">H·ªßy</button>
            <button class="btn" id="logoutConfirmYes" type="button"
              style="background:var(--secondary); background-color: red">ƒêƒÉng
              xu·∫•t</button>
          </div>
        </div>
      </div>
    </div>

    <!-- POPUP X√ÅC NH·∫¨N X√ìA C√îNG VI·ªÜC -->
    <div class="popup-overlay" id="confirmDelete" style="display:none;" aria-hidden="true">
      <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="confirmDelete-title">
        <div class="popup-header">
          <div id="confirmDelete-title" class="popup-title" style="color:red ;">X√≥a c√¥ng vi·ªác</div>
          <button class="close-btn" id="confirmDeleteClose" aria-label="ƒê√≥ng">&times;</button>
        </div>
        <div style="margin-top:12px">
          <p>B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
            <button class="btn" id="confirmDeleteNo" type="button" style="background:#9e9e9e">H·ªßy</button>
            <button class="btn" id="confirmDeleteYes" type="button" style="background:#ef4444;color:white">X√≥a</button>
          </div>
        </div>
      </div>
    </div>

    <!-- BODY -->
    <div class="dashboard-body" id="dashboardBody">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-search">
            <div class="mini-pill">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"></line>
              </svg>
              <input type="text" placeholder="Search" />
            </div>
          </div>
          <div class="sidebar-list" id="groupList">
          </div>
        </div>

        <!-- N√öT: T·∫†O NH√ìM -->
        <button class="cssbuttons-io-button" id="btnAddGroup" title="T·∫°o nh√≥m">
          T·∫°o nh√≥m
          <div class="icon">
            <svg height="24" width="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" fill="none" />
            </svg>
          </div>
        </button>
      </div>

      <!-- MAIN -->
      <div class="main-content" id="mainContent">
        <div class="main-toolbar">
          <div class="task-tabs">
            <button class="tab-btn active" tabindex="0" id="btnAssigned">
              <svg viewBox="0 0 20 20">
                <path d="M4 10l4 4 8-8" />
              </svg>
              ƒê√£ giao
            </button>
            <button class="tab-btn" tabindex="0" id="btnReceived">
              <svg viewBox="0 0 20 20">
                <circle cx="9" cy="9" r="7" />
                <path d="M13 13l4 4" />
              </svg>
              ƒê∆∞·ª£c giao
            </button>
          </div>

          <div class="search-pill">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="11" cy="11" r="7" stroke-width="2"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"></line>
            </svg>
            <input type="text" id="taskSearchInput" placeholder="Search" />
          </div>

          <div class="">
            <ul class="task-menu">
              <li>
                <a href="javascript:void(0)">B·ªô l·ªçc c√¥ng vi·ªác</a>
                <ul class="task-sub">
                  <li><a href="javascript:void(0)">T·∫•t c·∫£</a></li>
                  <li><a href="javascript:void(0)">ƒê√£ ho√†n th√†nh</a></li>
                  <li><a href="javascript:void(0)">ƒêang l√†m</a></li>
                  <li><a href="javascript:void(0)">Ch∆∞a nh·∫≠n</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>

        <!-- Danh s√°ch c√¥ng vi·ªác -->
        <div class="task-list" id="tasks-assigned"></div>
        <div class="task-list" id="tasks-received" style="display: none;"></div>

        <script>// chuy·ªÉn ƒë·ªïi lo·∫°i c√¥ng vi·ªác
          const assigned = document.getElementById('tasks-assigned');
          const received = document.getElementById('tasks-received');

          document.getElementById('btnAssigned').onclick = () => {
            assigned.style.display = 'block';
            received.style.display = 'none';
          };

          document.getElementById('btnReceived').onclick = () => {
            assigned.style.display = 'none';
            received.style.display = 'block';
          };
        </script>

        <!-- Load cong viec -->
        <script>
          async function loadTasks() {
            try {
              const taskAssignedList = document.getElementById("tasks-assigned");
              const taskReceivedList = document.getElementById("tasks-received");

              const assignedRes = await fetch("/groups/assignedTasks", { credentials: "same-origin" });
              const receivedRes = await fetch("/groups/receivedTasks", { credentials: "same-origin" });


              if (!assignedRes.ok) throw new Error("Assigned error: " + assignedRes.status);
              if (!receivedRes.ok) throw new Error("Received error: " + receivedRes.status);

              const assignedTasks = await assignedRes.json();
              const receivedTasks = await receivedRes.json();

              renderTasks(assignedTasks, taskAssignedList, "assigned");
              renderTasks(receivedTasks, taskReceivedList, "received");
            } catch (err) {
              console.error("L·ªói load:", err);
            }
          }

          const CURRENT_USER_ID = "<%= user.id || user._id || '' %>";

          // Normalize creator info from different task shapes
          function getCreatorInfo(task) {
            if (!task) return { name: '', avatar: '' };

            // Accept owner object variants
            const ownerObj = task.owner || task.ownerInfo || (task._doc && (task._doc.owner || task._doc.createdBy));
            if (ownerObj && typeof ownerObj === 'object') {
              return {
                name: ownerObj.name || ownerObj.username || ownerObj.fullName || ownerObj.ownerName || ownerObj.createdBy || '',
                avatar: ownerObj.avatarPath || ownerObj.avatar || ownerObj.ownerAvatar || ''
              };
            }

            // Fallback to top-level fields
            const name = task.ownerName || task.creatorName || task.createdBy || task.owner || '';
            const avatar = task.ownerAvatar || task.creatorAvatar || task.avatar || '';
            return { name, avatar };
          }

          function renderTasks(tasks, container, type) {
            container.innerHTML = "";

            tasks.forEach(task => {
              const taskId = task.id || task._id || (task._doc && (task._doc._id || task._doc.id)) || '';

              const div = document.createElement("div");

              // tag the DOM node so we can find it when removing after delete
              div.setAttribute('data-task-id', taskId);

              div.classList.add("task-assigned");
              div.style = `
      border:1px solid #e6e9ee;
      border-radius:10px;
      padding:16px;
      margin:10px 0;
      display:grid;
      grid-template-columns: 1.6fr 1.4fr 1fr 0.7fr 1fr 0.05fr;
      gap:20px;
      align-items:start;
      background:var(--surface);
    `;

              const { name: creatorName, avatar: creatorAvatar } = getCreatorInfo(task);
              const groupName = task.groupName || task.group?.name || 'Kh√¥ng thu·ªôc nh√≥m';

              /*1. TASK NAME + DESCRIPTION*/
              const col1 = document.createElement('div');
              col1.style = "display:flex;flex-direction:column;gap:8px;min-width:0";

              col1.innerHTML = `
      <div style="font-size:1.1rem;font-weight:700;color:var(--text);line-height:1.3">
        ${task.taskName}
      </div>

      <div style="
          color:var(--text-muted);
          font-size:0.9rem;
          max-height:48px;
          overflow:hidden;
          text-overflow:ellipsis;
          line-height:1.4;
      ">
        ${task.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}
      </div>
    `;

              /*2. NG∆Ø·ªúI T·∫†O C√îNG VI·ªÜC*/
              const col2 = document.createElement("div");
              col2.style = "display:flex;gap:12px;align-items:center;min-width:0";

              const avatarDiv = document.createElement("div");
              avatarDiv.style = `
      width:44px;height:44px;border-radius:50%;
      overflow:hidden;display:flex;align-items:center;justify-content:center;
      background:var(--border-color);flex-shrink:0;
    `;

              if (creatorAvatar) {
                avatarDiv.innerHTML = `<img src="${creatorAvatar}" style="width:100%;height:100%;object-fit:cover">`;
              } else {
                avatarDiv.innerHTML = `<span style="font-weight:700;color:var(--text);font-size:1rem;">
        ${(creatorName || '?').charAt(0).toUpperCase()}
      </span>`;
              }

              const creatorInfo = document.createElement("div");
              creatorInfo.style = "display:flex;flex-direction:column;gap:4px;min-width:0;flex:1";

              creatorInfo.innerHTML = `
      <div style="font-size:20px;font-weight:600;color:var(--text); white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
        ${groupName}
      </div>

      <div style="font-size:14px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
        ${creatorName}
      </div>
    `;

              col2.appendChild(avatarDiv);
              col2.appendChild(creatorInfo);

              /* 3. NG∆Ø·ªúI PH·ª§ TR√ÅCH */
              const col3 = document.createElement("div");
              col3.style = `
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:0;
`;

              // Ti√™u ƒë·ªÅ
              col3.innerHTML = `
  <div style="
      font-size:15px;
      font-weight:1000;
      color:var(--text-muted);
      text-transform:uppercase;
  ">
    Ng∆∞·ªùi ph·ª• tr√°ch
  </div>
`;

              // Wrapper ch·ª©a danh s√°ch assignees
              const assigneesWrap = document.createElement("div");
              assigneesWrap.id = `assignees_${taskId}`;
              assigneesWrap.style = `
  display:flex;
  flex-direction:column;
  gap:6px;
`;
              col3.appendChild(assigneesWrap);

              /*4. TR·∫†NG TH√ÅI*/
              const col4 = document.createElement("div");
              col4.style = "display:flex;flex-direction:column;align-items:center;gap:8px";
              col4.id = `task_status_${taskId}`;

              // Map task.status (pending | in_progress | done) to localized label + color
              const taskStatusMap = {
                done: { label: 'ƒê√£ ho√†n th√†nh', color: '#22c55e' },
                in_progress: { label: 'ƒêang l√†m', color: 'var(--primary)' },
                pending: { label: 'Ch∆∞a l√†m', color: '#f59e0b' }
              };
              const tstat = task.status || 'pending';
              const tmeta = taskStatusMap[tstat] || taskStatusMap['pending'];
              col4.innerHTML = `
      <div style="font-size:15px;
      font-weight:1000;
      color:var(--text-muted);
      text-transform:uppercase;">Tr·∫°ng th√°i</div>
      <div style="
          font-weigh:14px;
          font-weight:1000;
          color:${tmeta.color};
      ">
        ${tmeta.label}
      </div>
    `;

              /* 5. NG√ÄY TH√ÅNG*/
              const col5 = document.createElement("div");
              col5.style = "display:flex;flex-direction:column;gap:10px;font-size:0.95rem;font-weight:600;color:var(--text)";

              col5.innerHTML = `
      <div style="font-size:15px;
      font-weight:1000;
      color:var(--text-muted);
      text-transform:uppercase;">Th·ªùi h·∫°n 
      </div>

      <div style="display:flex;align-items:center;gap:6px;">
        üìÖ <span>${formatDate(task.createdAt)}</span>
      </div>

      <div style="display:flex;align-items:center;gap:6px;">
        ‚è∞ <span>${formatDate(task.deadline)}</span>
      </div>
    `;

              /* 6. X√≥a c√¥ng vi·ªác (n·∫øu l√† ng∆∞·ªùi t·∫°o) */
              const col6 = document.createElement("div");
              col6.style = "display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:0";

              // N·∫øu ng∆∞·ªùi hi·ªán t·∫°i l√† ng∆∞·ªùi t·∫°o task -> hi·ªÉn th·ªã n√∫t X√≥a
              try {
                const creatorId = task.creatorId || task.createdBy || task.ownerId || task.owner || '';
                const isCreator = String(creatorId) === String(CURRENT_USER_ID || '');
                if (isCreator) {
                  const delBtn = document.createElement('button');
                  delBtn.className = "task_delete_btn";
                  delBtn.innerHTML = `
  <svg width="22" height="22" viewBox="0 0 24 24" fill="#ef4444" xmlns="http://www.w3.org/2000/svg">
    <path d="M9 3L10 2H14L15 3H20V5H4V3H9ZM5 6H19L18.2 21.3C18.1 22.3 17.3 23 16.3 23H7.7C6.7 23 5.9 22.3 5.8 21.3L5 6ZM9 10V19H11V10H9ZM13 10V19H15V10H13Z"/>
  </svg>
`;
                  delBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // open modal confirm; actual deletion happens in modal handler
                    openConfirmDelete(taskId);
                  });
                  col6.appendChild(delBtn);
                }
              } catch (e) { console.debug('delete button render error', e); }

              /*ADD TO WRAPPER*/
              div.appendChild(col1);
              div.appendChild(col2);
              div.appendChild(col3);
              div.appendChild(col4);
              div.appendChild(col5);
              div.appendChild(col6);
              container.appendChild(div);

              div.style.cursor = "pointer";
              div.addEventListener("click", e => {
                if (e.target.closest("button") || e.target.closest("a")) return;
                openTaskDetail(task);
              });

              loadAssignees(taskId, assigneesWrap);
            });
          }

          // ===== x√≥a c√¥ng vi·ªác =====
          let _pendingDeleteTaskId = null;
          const confirmDeleteOverlay = document.getElementById('confirmDelete');
          const confirmDeleteYes = document.getElementById('confirmDeleteYes');
          const confirmDeleteNo = document.getElementById('confirmDeleteNo');
          const confirmDeleteClose = document.getElementById('confirmDeleteClose');

          function openConfirmDelete(taskId) {
            _pendingDeleteTaskId = taskId;
            if (confirmDeleteOverlay) {
              confirmDeleteOverlay.style.display = 'flex';
              confirmDeleteOverlay.classList.add('active');
              confirmDeleteOverlay.setAttribute('aria-hidden', 'false');
            }
          }

          function closeConfirmDelete() {
            _pendingDeleteTaskId = null;
            if (confirmDeleteOverlay) {
              confirmDeleteOverlay.style.display = 'none';
              confirmDeleteOverlay.classList.remove('active');
              confirmDeleteOverlay.setAttribute('aria-hidden', 'true');
            }
          }

          if (confirmDeleteNo) confirmDeleteNo.addEventListener('click', () => closeConfirmDelete());
          if (confirmDeleteClose) confirmDeleteClose.addEventListener('click', () => closeConfirmDelete());

          if (confirmDeleteYes) confirmDeleteYes.addEventListener('click', async () => {
            if (!_pendingDeleteTaskId) return closeConfirmDelete();
            try {
              const res = await deleteTask(_pendingDeleteTaskId);
              if (res && res.success) {
                const el = document.querySelector(`.task-assigned[data-task-id="${_pendingDeleteTaskId}"]`);
                if (el) el.remove();
                if (typeof showToast === 'function') showToast('ƒê√£ x√≥a c√¥ng vi·ªác');
              }
            } catch (e) {
              console.error('confirmDelete error', e);
            } finally {
              closeConfirmDelete();
            }
          });

          if (confirmDeleteOverlay) {
            confirmDeleteOverlay.addEventListener('click', (e) => {
              if (e.target === confirmDeleteOverlay) closeConfirmDelete();
            });
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape' && confirmDeleteOverlay.classList.contains('active')) closeConfirmDelete();
            });
          }

          // c·∫≠p nh·∫≠t tr·∫°ng th√°i
          async function loadAssignees(taskId, container) {
            if (!container) return;

            container.innerHTML = '<span style="font-size:0.75rem;color:var(--text-muted)">T·∫£i...</span>';

            try {
              const res = await fetch(`/groups/${taskId}/assignees`, { credentials: "same-origin" });
              if (!res.ok) throw new Error("L·ªói khi t·∫£i ng∆∞·ªùi ph·ª• tr√°ch");

              const assignees = await res.json();

              if (!Array.isArray(assignees) || assignees.length === 0) {
                container.innerHTML = '<span style="font-size:0.75rem;color:var(--text-muted)">Kh√¥ng c√≥</span>';
                return;
              }

              // Avatar fallback m√†u
              const colors = ["#f87171", "#fb923c", "#facc15", "#4ade80", "#60a5fa", "#a78bfa", "#f472b6"];

              const getAvatarHTML = (user) => {
                if (user.avatarPath && user.avatarPath.trim() !== "") {
                  return `<img src="${user.avatarPath}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid var(--border-color);">`;
                }

                const letter = (user.name || '?').charAt(0).toUpperCase();
                const key = `avatarColor_${user.userId || user.name}`;
                let color = localStorage.getItem(key);

                if (!color) {
                  color = colors[Math.floor(Math.random() * colors.length)];
                  localStorage.setItem(key, color);
                }

                return `
        <div style="
          width:24px;height:24px;border-radius:50%;
          background:${color};color:white;
          display:flex;align-items:center;justify-content:center;
          font-weight:600;font-size:0.75rem">
          ${letter}
        </div>
      `;
              };

              // Thay to√†n b·ªô mapping tr·∫°ng th√°i ·ªü ƒë√¢y
              // tr·∫°ng th√°i ri√™ng 
              const getStatus = (status) => {
                switch (status) {
                  case "done":
                    return { icon: "  ‚úî", label: "Ho√†n th√†nh", color: "#22c55e" }; // xanh l√°
                  case "in_progress":
                    return { icon: "  ‚è≥", label: "ƒêang l√†m", color: "#3b82f6" }; // xanh d∆∞∆°ng
                  default:
                    return { icon: "  üïí", label: "Ch∆∞a l√†m", color: "#f59e0b" }; // v√†ng
                }
              };

              // T√≠nh to√°n tr·∫°ng th√°i chung c·ªßa nhi·ªám v·ª• t·ª´ nh·ªØng ng∆∞·ªùi ƒë∆∞·ª£c giao nhi·ªám v·ª•.
              let overall = 'pending';
              if (Array.isArray(assignees) && assignees.length > 0) {
                const allDone = assignees.every(a => a.assigneeStatus === 'done');
                const anyInProgress = assignees.some(a => a.assigneeStatus === 'in_progress');
                if (allDone) overall = 'done';
                else if (anyInProgress) overall = 'in_progress';
                else overall = 'pending';
              }

              const statusMap = {
                done: { label: 'ƒê√£ ho√†n th√†nh', color: '#22c55e' },
                in_progress: { label: 'ƒêang l√†m', color: 'var(--primary)' },
                pending: { label: 'Ch∆∞a l√†m', color: '#f59e0b' }
              };
              const overallMeta = statusMap[overall] || statusMap.pending;
              // Update task-level status display if present
              const statusEl = document.getElementById(`task_status_${taskId}`);
              if (statusEl) {
                statusEl.innerHTML = `\n                <div style="font-size:15px;color:var(--text-muted);font-weight:1000;text-transform:uppercase">Tr·∫°ng th√°i</div>\n                <div style="font-size:1.1rem;font-weight:700;color:${overallMeta.color};">${overallMeta.label}</div>\n              `;
              }

              // Build assignees list HTML with optional action buttons for the current user
              let _html = '';
              for (const u of assignees) {
                const userName = u.name || u.username || 'Ng∆∞·ªùi d√πng';
                const st = getStatus(u.assigneeStatus);
                const isCurrent = String(u.userId || u.id || u.user_id || '') === String(CURRENT_USER_ID || '');

                // action button for current user: Pending -> Nh·∫≠n (in_progress), in_progress -> Ho√†n th√†nh (done)
                let actionBtn = '';
                if (isCurrent) {
                  if (!u.assigneeStatus || u.assigneeStatus === 'pending') {
                    actionBtn = `<button onclick="updateAssigneeStatus('${taskId}', '${u.userId || u.id}', 'in_progress')" style="padding:6px 8px;border-radius:6px;border:none;background:#2563eb;color:white;font-weight:600;cursor:pointer">Nh·∫≠n</button>`;
                  } else if (u.assigneeStatus === 'in_progress') {
                    // allow current in-progress user to mark as done directly from list
                    actionBtn = `<button onclick="updateAssigneeStatus('${taskId}', '${u.userId || u.id}', 'done')" style="padding:6px 8px;border-radius:6px;border:none;background:#16a34a;color:white;font-weight:600;cursor:pointer">Ho√†n th√†nh</button>`;
                  }
                }

                // avatar (left) + name + status text to the right of the name
                const avatarHTML = getAvatarHTML(u);

                _html += `
          <div style="
            display:flex;
            align-items:center;
            gap:10px;
            font-size:0.85rem;
            padding:6px 8px;
            border-radius:6px;
            background:var(--surface);
            border:1px solid var(--border-color);
          " title="${userName} - ${st.label}">

            ${avatarHTML}

            <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
              <span style="
                color:var(--text);
                font-weight:600;
                white-space:nowrap;
                overflow:hidden;
                text-overflow:ellipsis;
              ">${userName}</span>

              <span style="color:${st.color};font-weight:600;font-size:0.85rem;white-space:nowrap">${st.icon} ${st.label}</span>
            </div>

            ${actionBtn}
          </div>
        `;
              }
              container.innerHTML = _html;

            } catch (err) {
              console.error("‚ùå loadAssignees error:", err);
              container.innerHTML = '<span style="color:#ef4444;font-size:0.75rem">L·ªói</span>';
            }
          }

          // C·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi ƒë∆∞·ª£c giao nhi·ªám v·ª• cho m·ªôt t√°c v·ª• v√† ng∆∞·ªùi d√πng c·ª• th·ªÉ.
          async function updateAssigneeStatus(taskId, userId, status) {
            if (!taskId || !userId || !status) return;
            try {
              console.debug('updateAssigneeStatus ->', { taskId, userId, status });
              const res = await fetch(`/tasks/${taskId}/assignees/${userId}/status`, {
                method: 'PUT',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
              });
              let data = {};
              try { data = await res.json(); } catch (e) { /* ignore json parse errors */ }
              if (!res.ok) {
                console.warn('updateAssigneeStatus failed', res.status, data);
                if (typeof showToast === 'function') showToast(data.error || 'L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'error');
              } else {
                if (typeof showToast === 'function') showToast(data.message || 'C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng');
              }

              // Lu√¥n l√†m m·ªõi giao di·ªán ng∆∞·ªùi ƒë∆∞·ª£c giao nhi·ªám v·ª• ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y ƒë∆∞·ª£c tr·∫°ng th√°i hi·ªán t·∫°i.
              const containerEl = document.getElementById(`assignees_${taskId}`);
              if (containerEl) loadAssignees(taskId, containerEl);

              // Debounced full task list refresh so the list view updates too
              if (!window._loadTasksTimer) window._loadTasksTimer = null;
              if (window._loadTasksTimer) clearTimeout(window._loadTasksTimer);
              window._loadTasksTimer = setTimeout(() => {
                try { if (typeof loadTasks === 'function') loadTasks(); } catch (e) { console.debug('loadTasks call failed', e); }
              }, 250);

              // ƒê·ªìng th·ªùi y√™u c·∫ßu m√°y ch·ªß t√≠nh to√°n l·∫°i tr·∫°ng th√°i chung
              try {
                const g = await fetch(`/tasks/${taskId}/status`, {
                  method: 'PUT',
                  credentials: 'same-origin',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({})
                });
                if (!g.ok) console.debug('Global status update returned', g.status);
              } catch (e) {
                console.debug('Global status update error', e);
              }

            } catch (err) {
              console.error('‚ùå updateAssigneeStatus error:', err);
              alert(err.message || 'L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i');
            }
          }

          // X√≥a task (g·ªçi t·ªõi backend DELETE /tasks/:taskId)
          async function deleteTask(taskId) {
            if (!taskId) return { success: false };
            try {
              const res = await fetch(`/tasks/${taskId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
              });
              let data = {};
              try { data = await res.json(); } catch (e) { }
              if (!res.ok) {
                if (typeof showToast === 'function') showToast(data.error || 'L·ªói x√≥a c√¥ng vi·ªác', 'error');
                return { success: false, error: data.error };
              }
              return { success: true, data };
            } catch (err) {
              console.error('‚ùå deleteTask error:', err);
              if (typeof showToast === 'function') showToast('L·ªói x√≥a c√¥ng vi·ªác', 'error');
              return { success: false, error: err.message };
            }
          }


          function formatDate(dateString) {
            if (!dateString) return "";
            const d = new Date(dateString);
            return d.toLocaleDateString("vi-VN");
          }

          // G·ªçi h√†m
          loadTasks();

          // --- SEARCH TASKS ---
          const taskSearchInput = document.getElementById("taskSearchInput");

          taskSearchInput.addEventListener("input", function () {
            const keyword = this.value.trim().toLowerCase();

            // l·∫•y t·∫•t c·∫£ task (assigned + received)
            document.querySelectorAll(".task-assigned").forEach(task => {

              // t√™n task n·∫±m trong col1 -> div ƒë·∫ßu ti√™n
              const taskNameEl = task.querySelector("div div:nth-child(1)");
              const taskName = taskNameEl ? taskNameEl.textContent.trim().toLowerCase() : "";

              // ki·ªÉm tra match
              if (taskName.includes(keyword)) {
                task.style.display = "grid";  // gi·ªØ nguy√™n layout
              } else {
                task.style.display = "none";
              }
            });
          });

          // ========== FILTER TASKS BY STATUS ==========
          document.querySelectorAll(".task-sub li a").forEach(option => {
            option.addEventListener("click", () => {

              const filterText = option.textContent.trim(); // l·∫•y text: "ƒê√£ ho√†n th√†nh", "ƒêang l√†m", "Ch∆∞a nh·∫≠n", ...

              // G·ªçi h√†m l·ªçc
              filterTasks(filterText);
            });
          });


          function filterTasks(filterText) {
            const allTasks = document.querySelectorAll(".task-assigned");

            allTasks.forEach(task => {

              // L·∫•y ph·∫ßn tr·∫°ng th√°i hi·ªÉn th·ªã trong HTML
              const statusEl = task.querySelector('[id^="task_status_"] div:nth-child(2)');
              if (!statusEl) return;

              const statusText = statusEl.textContent.trim(); // v√≠ d·ª•: "ƒê√£ ho√†n th√†nh"

              // RULES:
              // T·∫•t c·∫£          ‚Üí lu√¥n hi·ªán
              // ƒê√£ ho√†n th√†nh  ‚Üí match "ƒê√£ ho√†n th√†nh"
              // ƒêang l√†m       ‚Üí match "ƒêang l√†m"
              // Ch∆∞a nh·∫≠n      ‚Üí match "Ch∆∞a l√†m"

              let show = false;

              if (filterText === "T·∫•t c·∫£") {
                show = true;
              }
              else if (filterText === "ƒê√£ ho√†n th√†nh" && statusText.includes("ƒê√£ ho√†n th√†nh")) {
                show = true;
              }
              else if (filterText === "ƒêang l√†m" && statusText.includes("ƒêang l√†m")) {
                show = true;
              }
              else if (filterText === "Ch∆∞a nh·∫≠n" && statusText.includes("Ch∆∞a l√†m")) {
                show = true;
              }

              task.style.display = show ? "grid" : "none";
            });
          }


        </script>
      </div>

      <!-- RIGHT PANEL STACK -->
      <div class="right-panel-stack" id="rightPanelStack">
        <div class="right-panel half" id="calendarPanel">
          <div class="panel-head">
            <span class="panel-title">
              <svg width="20" height="20" style="vertical-align: middle; margin-right: 6px" fill="none"
                stroke="currentColor">
                <rect x="3" y="4" width="14" height="14" rx="2" stroke-width="2" />
                <line x1="7" y1="2" x2="7" y2="6" stroke-width="2" />
                <line x1="13" y1="2" x2="13" y2="6" stroke-width="2" />
              </svg>
              L·ªãch
            </span>
            <button class="close-panel" id="closeCalendarPanel" title="ƒê√≥ng">
              &times;
            </button>
          </div>
          <div class="right-section" id="calendarPanelContent"></div>
        </div>

        <div class="right-panel half" id="notifPanel">
          <div class="panel-head">
            <span class="panel-title">
              <svg width="20" height="20" style="vertical-align: middle; margin-right: 6px" fill="none"
                stroke="currentColor">
                <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-width="2"></path>
                <path d="M13.73 21a2 2 0 01-3.46 0" stroke-width="2"></path>
              </svg>
              Th√¥ng b√°o
            </span>
            <button class="close-panel" id="closeNotifPanel" title="ƒê√≥ng">
              &times;
            </button>
          </div>
          <div class="right-section" id="notifPanelContent"></div>
        </div>
      </div>

      <script>
        function renderNotif(notifs) {
          const notifList = document.getElementById("notifPanelContent");
          notifList.innerHTML = "";

          if (!notifs || notifs.length === 0) {
            notifList.innerHTML = `
            <div class="notif-empty">Kh√¥ng c√≥ th√¥ng b√°o</div>
        `;
            return;
          }

          notifs.forEach(notif => {
            const div = document.createElement("div");
            div.classList.add("notif-item");

            // N·∫øu ch∆∞a ƒë·ªçc ‚Üí th√™m class highlight
            if (!notif.isRead) div.classList.add("unread");

            div.innerHTML = `
            <div class="notif-dot"></div>
            <div class="notif-content">
                <div class="notif-message">${notif.message}</div>
                <div class="notif-time">${formatNotifTime(notif.createdAt)}</div>
            </div>
        `;

            // Khi click v√†o th√¥ng b√°o
            div.addEventListener("click", async () => {
              // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
              if (!notif.isRead) {
                await fetch(`/groups/notifications/${notif.id}/read`, {
                  method: "POST"
                });
              }

              // Khi click v√†o th√¥ng b√°o
              div.addEventListener("click", async () => {

                // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
                if (!notif.isRead) {
                  await fetch(`/groups/notifications/${notif.id}/read`, { method: "POST" });
                }

                // N·∫øu th√¥ng b√°o li√™n quan ƒë·∫øn task ‚Üí quay v·ªÅ dashboard v√† highlight task
                if (notif.type === "task" && notif.referenceId) {
                  window.location.href = `/?openTask=${notif.referenceId}`;
                }
              });

            });

            notifList.appendChild(div);
          });
        }

        async function loadNotifs() {
          const res = await fetch("/groups/notifications");
          const data = await res.json();
          renderNotif(data);
        }
      </script>

      <!-- POPUP T·∫†O NH√ìM -->
      <div class="popup-overlay" id="popupGroup" aria-hidden="true">
        <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="create-group-title">
          <button class="close-btn" id="closeGroupPopup" aria-label="ƒê√≥ng">
            &times;
          </button>
          <div class="popup-inner-content" style="flex-direction: column; width: 100%">
            <div>
              <div id="create-group-title" class="popup-title">
                T·∫°o nh√≥m m·ªõi
              </div>
              <form id="groupForm" action="/groups" method="POST" style="
                    display: flex;
                    flex-direction: column;
                    gap: 18px;
                    min-width: 260px;
                  ">
                <input type="hidden" name="csrf_token" value="" />
                <div style="display: flex; flex-direction: column; gap: 6px">
                  <label style="height: 20px;"></label>
                  <input id="groupName" name="groupName" type="text" required placeholder="Nh·∫≠p t√™n nh√≥m"
                    class="form-input" style="padding: 10px 13px" />
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 12px">
                  <button type="button" class="btn" id="cancelGroupBtn" style="background: #9e9e9e">
                    Hu·ª∑
                  </button>
                  <button type="submit" class="btn" id="createGroupBtn">
                    T·∫°o nh√≥m
                  </button>
                </div>
              </form>

              <!-- hi·ªÉn th·ªã th√¥ng b√°o  -->
              <script>
                function showToast(message, type = 'success') {
                  const container = document.getElementById('toast-container');
                  if (!container) return;
                  const toast = document.createElement('div');
                  toast.className = `toast ${type}`;
                  toast.textContent = message;

                  container.appendChild(toast);
                  setTimeout(() => toast.classList.add('show'), 100);
                  setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                  }, 4000);
                }
              </script>

              <!-- javascript hi·ªán c·ª≠a s·ªï t·∫°o nh√≥m -->
              <script>
                const popupGroup = document.getElementById('popupGroup');
                // n√∫t ƒë·ªÉ m·ªü popup (d√≤ng 1500)
                const btnAddGroup = document.getElementById('btnAddGroup');
                const closeGroupPopup = document.getElementById('closeGroupPopup'); // n√∫t X
                const cancelGroupBtn = document.getElementById('cancelGroupBtn'); // n√∫t Hu·ª∑

                // H√†m m·ªü popup
                function openGroupPopup() {
                  popupGroup.style.display = 'flex';
                  popupGroup.style.alignItems = 'center';
                  popupGroup.style.justifyContent = 'center';
                  popupGroup.style.backdropFilter = 'blur(2px)';
                }

                // H√†m ƒë√≥ng popup
                function closeGroup() {
                  popupGroup.style.display = 'none';
                }

                // S·ª± ki·ªán m·ªü popup 
                if (btnAddGroup) {
                  btnAddGroup.addEventListener('click', openGroupPopup);
                }

                // S·ª± ki·ªán ƒë√≥ng popup khi b·∫•m n√∫t X ho·∫∑c Hu·ª∑
                closeGroupPopup.addEventListener('click', closeGroup);
                cancelGroupBtn.addEventListener('click', closeGroup);

                // ƒê√≥ng popup khi click ra ngo√†i ph·∫ßn n·ªôi dung
                popupGroup.addEventListener('click', function (e) {
                  if (e.target === popupGroup) {
                    closeGroup();
                  }
                });
                // ---------------------------------------------------
                // Load danh s√°ch nh√≥m ƒë√£ tham gia
                async function loadGroups() {
                  const groupList = document.getElementById('groupList');
                  if (!groupList) return;
                  groupList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">ƒêang t·∫£i...</div>';
                  try {
                    const res = await fetch('/groups/my-groups', { credentials: 'same-origin' });
                    if (!res.ok) throw new Error('L·ªói khi t·∫£i nh√≥m');
                    const groups = await res.json();
                    if (!Array.isArray(groups) || groups.length === 0) {
                      groupList.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">B·∫°n ch∆∞a tham gia nh√≥m n√†o.</div>';
                      return;
                    }
                    groupList.innerHTML = groups.map(g => {
                      const leaderName = g.leaderName || 'Kh√¥ng r√µ';
                      return `
                      <div class="group-card" data-id="${g.id}" >
                        <div class="group-title">${g.groupName}</div>
                        <div class="group-leader">Nh√≥m tr∆∞·ªüng: <span>${leaderName}</span></div>
                      </div>
                      `;
                    }).join('');

                    // Th√™m s·ª± ki·ªán click sau khi render
                    document.querySelectorAll('.group-card').forEach(card => {
                      card.addEventListener('click', () => {
                        const groupId = card.getAttribute('data-id');
                        window.location.href = `/groups/${groupId}`; // render group.ejs t∆∞∆°ng ·ª©ng
                      });
                    });
                  } catch (err) {
                    groupList.innerHTML = '<div style="color:#ef4444;text-align:center;padding:20px;">L·ªói khi t·∫£i danh s√°ch nh√≥m.</div>';
                  }
                }
                window.addEventListener('DOMContentLoaded', loadGroups);

                document.querySelector('.sidebar-search input').addEventListener('input', e => {
                  const keyword = e.target.value.toLowerCase();
                  document.querySelectorAll('.group-card').forEach(card => {
                    const name = card.querySelector('.group-title').textContent.toLowerCase();
                    card.style.display = name.includes(keyword) ? '' : 'none';
                  });
                });

                // X·ª≠ l√Ω submit t·∫°o nh√≥m
                const groupForm = document.getElementById('groupForm');
                if (groupForm) {
                  groupForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const groupName = document.getElementById('groupName').value.trim();
                    if (!groupName) return alert('Vui l√≤ng nh·∫≠p t√™n nh√≥m');
                    try {
                      const res = await fetch('/groups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ groupName }),
                        credentials: 'same-origin'
                      });
                      const data = await res.json();
                      // if (!res.ok) throw new Error(data.error || 'L·ªói t·∫°o nh√≥m');
                      // alert('T·∫°o nh√≥m th√†nh c√¥ng!');
                      if (!res.ok) {
                        showToast(data.error || 'L·ªói t·∫°o nh√≥m', 'error');
                      } else {
                        showToast('T·∫°o nh√≥m th√†nh c√¥ng!', 'success');
                      }

                      groupForm.reset();
                      document.getElementById('popupGroup').style.display = 'none';
                      loadGroups();
                    } catch (err) {
                      alert(err.message || 'L·ªói khi t·∫°o nh√≥m');
                    }
                  });
                }
              </script>
            </div>
          </div>
        </div>
      </div>

      <!-- POPUP TH√îNG TIN T√ÄI KHO·∫¢N -->
      <div class="popup-overlay" id="popupProfile"
        style="display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); z-index: 1000;"
        aria-hidden="true">
        <div class="popup-content" style="width: 420px; max-width: 95vw" role="dialog" aria-modal="true"
          aria-labelledby="profile-title">
          <div class="popup-header">
            <div id="profile-title" class="popup-title" style="font-size: 23px">Th√¥ng tin t√†i kho·∫£n</div>
            <button class="close-btn" id="closeProfileBtn" style="font-size: 28px" aria-label="ƒê√≥ng">&times;</button>
            <!-- javascript ƒë√≥ng popup hi·ªán th√¥ng tin -->
            <script>
              // L·∫•y ph·∫ßn t·ª≠ popup v√† n√∫t ƒë√≥ng
              const popupProfile = document.getElementById('popupProfile');
              const closeProfileBtn = document.getElementById('closeProfileBtn');

              // ===== Account menu & profile popup =====
              const openProfile = document.getElementById("openProfile");
              const userMenu = document.getElementById("userMenu");
              openProfile.addEventListener("click", function (e) {
                e.stopPropagation();
                userMenu.style.display =
                  userMenu.style.display === "block" ? "none" : "block";
              });
              document.addEventListener("mousedown", function (e) {
                if (!openProfile.contains(e.target)) {
                  userMenu.style.display = "none";
                }
              });
              document.getElementById("Profile").onclick = function () {
                document.getElementById("popupProfile").style.display = "flex";
                document
                  .getElementById("popupProfile")
                  .setAttribute("aria-hidden", "false");
                userMenu.style.display = "none";
              };

              // Khi b·∫•m n√∫t X th√¨ ·∫©n popup
              closeProfileBtn.addEventListener('click', function () {
                popupProfile.style.display = 'none';
              });
            </script>
          </div>

          <!-- FORM -->
          <form class="profile-form" id="profileForm" action="/info" method="POST" enctype="multipart/form-data">
            <!-- Background + Avatar upload -->
            <div class="profile-hero">
              <div class="background">
                <img id="bgPreview" name="backgroundPath" alt="background"
                  src="<%= user.backgroundPath || '/uploads/default-bg.png' %>" />
                <label class="bg-upload">
                  Thay ƒë·ªïi
                  <input type="file" id="backgroundInput" name="background" accept="image/*" style="display: none"
                    onchange="previewImage(event, 'bgPreview')" />
                </label>
              </div>
              <div class="avatar">
                <img id="avatarPreview" name="avatarPath" alt="avatar"
                  src="<%= user.avatarPath || '/uploads/default-avatar.png' %>" />
                <label class="avatar-upload">
                  ‚úé
                  <input type="file" id="avatarInput" name="avatar" accept="image/*" style="display: none"
                    onchange="previewImage(event, 'avatarPreview')" />
                </label>
              </div>

              <!-- Th√¥ng tin t√†i  kho·∫£n -->
              <div>
                <input class="name" type="text" name="name" value="<%= user.name || '' %>" readonly>
              </div>
            </div>

            <input type="hidden" name="csrf_token" value="" />
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="username" style="width: 110px">T√™n t√†i kho·∫£n</label>
              <input class="form-input" name="username" type="text" value="<%= user.username %>" readonly id="username"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="email" style="width: 110px">Email</label>
              <input class="form-input" name="email" type="email" value="<%= user.email %>" readonly id="email"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="phone" style="width: 110px">S·ªë ƒëi·ªán tho·∫°i</label>
              <input class="form-input" name="phoneNumber" type="text" value="<%= user.phoneNumber || '' %>" readonly
                id="phone" style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="dob" style="width: 110px">Ng√†y sinh</label>
              <input class="form-input" name="dob" type="date"
                value="<%= user.dob ? new Date(user.dob).toISOString().split('T')[0] : '' %>" readonly id="dob"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items:center; gap:10px">
              <label class="form-label" for="gender" style="width: 110px">Gi·ªõi t√≠nh</label>
              <input class="form-input" name="gender" type="text" value="<%=user.gender || '' %>" readonly id="gender"
                style="flex: 1; padding: 10px 13px" />
            </div>
            <div class="form-row" style="display: flex; align-items: center; gap: 10px">
              <label class="form-label" for="address" style="width: 110px">ƒê·ªãa ch·ªâ</label>
              <input class="form-input" name="address" type="text" value="<%= user.address || '' %>" readonly
                id="address" style="flex: 1; padding: 10px 13px" />
            </div>
          </form>
          <!------------------------------------------- POPUP X√ÅC NH·∫¨N UPLOAD ·∫¢NH  ------------------------------------------->
          <div class="confirm-overlay" id="confirmOverlay"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:1100;">
            <div class="confirm-box"
              style="background:#fff; padding:22px 28px; border-radius:10px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1); transform:scale(0.95); transition:all 0.2s ease;">
              <p style="margin-bottom:15px; font-size:17px; font-weight:500; color:var(--text);">B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?
              </p>
              <div style="display:flex; justify-content:center; gap:10px;">
                <button id="confirmYes" class="btn"
                  style="background:#4CAF50; color:white; padding:6px 14px; border:none; border-radius:6px; cursor:pointer;">X√°c
                  nh·∫≠n</button>
                <button id="confirmNo" class="btn"
                  style="background:#f44336; color:white; padding:6px 14px; border:none; border-radius:6px; cursor:pointer;">H·ªßy</button>
              </div>
            </div>
          </div>
          <!------------------------------------------------------------------------------------------------------>
          <script>
            const profileForm = document.getElementById('profileForm');
            const avatarInput = document.getElementById('avatarInput');
            const backgroundInput = document.getElementById('backgroundInput');
            const confirmOverlay = document.getElementById('confirmOverlay');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            //const popupProfile = document.getElementById('popupProfile');

            // Khi ch·ªçn ·∫£nh m·ªõi -> hi·ªán popup x√°c nh·∫≠n
            avatarInput.addEventListener('change', handleImageChange);
            backgroundInput.addEventListener('change', handleImageChange);

            function handleImageChange(event) {
              const file = event.target.files[0];
              if (!file) return;
              previewImage(event, event.target.id === 'avatarInput' ? 'avatarPreview' : 'bgPreview');
              confirmOverlay.style.display = 'flex';
            }

            // H√†m xem tr∆∞·ªõc ·∫£nh
            function previewImage(event, previewId) {
              const file = event.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (e) => {
                document.getElementById(previewId).src = e.target.result;
              };
              reader.readAsDataURL(file);
            }

            // Khi b·∫•m ‚ÄúX√°c nh·∫≠n‚Äù => submit form + ƒë√≥ng popup
            confirmYes.addEventListener('click', () => {
              confirmOverlay.style.display = 'none';
              profileForm.submit(); // g·ª≠i form ƒë·ªÉ backend l∆∞u v√†o DB
              popupProfile.style.display = 'none'; // ƒë√≥ng popup th√¥ng tin
            });

            // Khi b·∫•m ‚ÄúH·ªßy‚Äù => ƒë√≥ng popup x√°c nh·∫≠n
            confirmNo.addEventListener('click', () => {
              confirmOverlay.style.display = 'none';
              avatarInput.value = "";
              backgroundInput.value = "";
            });
          </script>

          <!-- <div class="confirm-overlay" id="confirmOverlay"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:1100;">
            <div class="confirm-box"
              style="background:#fff; padding:22px 28px; border-radius:10px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.1); transform:scale(0.95); transition:all 0.2s ease;">
              <p style="margin-bottom:15px; font-size:17px; font-weight:500; color:var(--text);">B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?
              </p>
              <div style="display:flex; justify-content:center; gap:10px;">
                <button id="confirmYes" class="btn"
                  style="background:#4CAF50; color:white; padding:6px 14px; border:none; border-radius:6px; cursor:pointer;">X√°c
                  nh·∫≠n</button>
                <button id="confirmNo" class="btn"
                  style="background:#f44336; color:white; padding:6px 14px; border:none; border-radius:6px; cursor:pointer;">H·ªßy</button>
              </div>
            </div>
          </div> -->

          <!-- ========== WORKHUB SETTINGS OVERLAY ========== -->
          <div id="whSettings" class="wh-settings" aria-hidden="true">
            <!-- Sidebar c√†i ƒë·∫∑t -->
            <div class="wh-wrap">
              <aside class="wh-side">
                <div class="wh-search"><input placeholder="T√¨m ki·∫øm..." /></div>
                <div class="wh-group">C√ÄI ƒê·∫∂T NG∆Ø·ªúI D√ôNG</div>
                <nav class="wh-nav">
                  <button class="wh-nav-item wh-active" data-view="account">
                    T√†i Kho·∫£n C·ªßa T√¥i
                  </button>
                  <!-- ch∆∞a nghƒ© ra c√†i ƒë·∫∑t g√¨ kh√°c -->
                </nav>
                <div class="wh-group">C√ÄI ƒê·∫∂T TRANG WEB</div>
                <nav class="wh-nav">
                  <button></button>
                  <!-- ch∆∞a nghƒ© ra c√†i ƒë·∫∑t g√¨ kh√°c -->
                </nav>
              </aside>

              <main class="wh-main">
                <header class="wh-topbar">
                  <div class="wh-title">T√†i Kho·∫£n C·ªßa T√¥i</div>
                  <button class="wh-btn wh-primary" id="whClose" title="ESC">
                    ƒê√≥ng
                  </button>
                </header>
                <!-- Th√¥ng tin t√†i kho·∫£n ------------------------------------------------------------>
                <form class="wh-card" action="/info" method="post" id="settingInfoAccount">
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">T√™n hi·ªÉn th·ªã</div>
                      <input class="form-input" type="text" name="name" value="<%= user.name || '' %>" readonly
                        style="flex: 1; padding: 10px 13px">
                    </div>
                  </div>
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">T√™n ƒëƒÉng nh·∫≠p</div>
                      <input class="form-input" name="username" type="text" value="<%= user.username %>" readonly
                        id="username" style="flex: 1; padding: 10px 13px" />
                    </div>
                  </div>
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">Email</div>
                      <input class="form-input" name="email" type="email" value="<%= user.email %>" readonly id="email"
                        style="flex: 1; padding: 10px 13px" />
                    </div>
                  </div>
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">S·ªë ƒêi·ªán Tho·∫°i</div>
                      <input class="form-input" name="phoneNumber" type="text" value="<%= user.phoneNumber || '' %>"
                        readonly id="phone" style="flex: 1; padding: 10px 13px" />
                    </div>
                  </div>
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">Ng√†y sinh</div>
                      <input class="form-input" name="dob" type="date"
                        value="<%= user.dob ? new Date(user.dob).toISOString().split('T')[0] : '' %>" readonly id="dob"
                        style="flex: 1; padding: 10px 13px" />
                    </div>
                  </div>
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">Gi·ªõi t√≠nh</div>
                      <select class="form-input" name="gender" id="gender" disabled style="flex: 1; padding: 10px 13px">
                        <option value="">--Ch·ªçn--</option>
                        <option value="male" <%=user.gender==='male' ? 'selected' : '' %>>Nam</option>
                        <option value="female" <%=user.gender==='female' ? 'selected' : '' %>>N·ªØ</option>
                        <option value="other" <%=user.gender==='other' ? 'selected' : '' %>>Kh√°c</option>
                      </select>
                    </div>
                  </div>
                  <div class="wh-row">
                    <div>
                      <div class="wh-label">ƒê·ªãa ch·ªâ</div>
                      <input class="form-input" name="address" type="text" value="<%= user.address || '' %>" readonly
                        id="address" style="flex: 1; padding: 10px 13px" />
                    </div>
                  </div>
                  <div class="wh-btnEditProfile" style="margin-top: 10px; text-align: center;">
                    <button class="btn" type="button" id="editProfileBtn"
                      style="background: var(--secondary)">S·ª≠a</button>
                    <button class="btn" type="submit" id="saveProfileBtn"
                      style="display: none; background: var(--secondary)">X√°c nh·∫≠n</button>
                  </div>

                  <!-- javascript s·ª≠a th√¥ng tin -->
                  <script>
                    const editBtn = document.getElementById("editProfileBtn");
                    const saveBtn = document.getElementById("saveProfileBtn");

                    editBtn.addEventListener("click", () => {
                      // ·∫®n n√∫t "S·ª≠a"
                      editBtn.style.display = "none";

                      // Hi·ªán n√∫t "X√°c nh·∫≠n"
                      saveBtn.style.display = "inline-block";

                      // M·ªü kh√≥a c√°c input (tr·ª´ username v√† email)
                      document.querySelectorAll("input[readonly], select[disabled]").forEach(el => {
                        const fieldName = el.getAttribute("name");
                        if (fieldName !== "username" && fieldName !== "email") {
                          el.removeAttribute("readonly");
                          el.removeAttribute("disabled");
                          el.style.background = "#fff";
                        }
                      });
                    });

                    // Khi b·∫•m "X√°c nh·∫≠n" th√¨ ƒë·ªïi l·∫°i n√∫t "S·ª≠a"
                    saveBtn.addEventListener("click", () => {
                      editBtn.style.display = "inline-block";
                      saveBtn.style.display = "none";
                    });
                  </script>
                </form>
                <!-- ----------------------------------------------------------------------------------------- -->
                <div class="wh-tabs">
                  <button class="wh-tab wh-active" data-tab="security">
                    B·∫£o m·∫≠t
                  </button>
                  <button class="wh-tab" data-tab="status">Tr·∫°ng th√°i</button>
                </div>
                <div class="wh-panel wh-show" data-tab="security">
                  <h3 class="wh-section">M·∫≠t Kh·∫©u v√† X√°c Th·ª±c</h3>
                  <div class="wh-card">
                    <div class="wh-row wh-between">
                      <div>
                        <div class="wh-t">ƒê·ªïi M·∫≠t Kh·∫©u</div>
                        <div class="wh-sub">
                          C·∫≠p nh·∫≠t m·∫≠t kh·∫©u ƒë·ªÉ b·∫£o v·ªá t√†i kho·∫£n.
                        </div>
                      </div>
                      <button class="wh-btn wh-primary" id="changePassword">ƒê·ªïi M·∫≠t Kh·∫©u</button>
                      <script>
                        document.getElementById("changePassword").addEventListener("click", () => {
                          window.location.href = "/info/changePassword";
                        });
                      </script>
                    </div>
                    <hr style="border: 0; border-top: 1px solid var(--border-color)" />
                    <div class="wh-row wh-between">
                      <div>
                        <div class="wh-t">·ª®ng D·ª•ng X√°c Th·ª±c</div>
                        <div class="wh-sub">
                          Th√™m l·ªõp b·∫£o m·∫≠t b·ªï sung khi ƒëƒÉng nh·∫≠p.
                        </div>
                      </div>
                      <button class="wh-btn wh-primary">
                        B·∫≠t ·ª®ng D·ª•ng X√°c Th·ª±c
                      </button>
                    </div>
                    <hr style="border: 0; border-top: 1px solid var(--border-color)" />
                    <div class="wh-row wh-between">
                      <div>
                        <div class="wh-t">M√£ b·∫£o m·∫≠t</div>
                        <div class="wh-sub">
                          T·∫°o m√£ d·ª± ph√≤ng ƒë·ªÉ ƒëƒÉng nh·∫≠p an to√†n.
                        </div>
                      </div>
                      <button class="wh-btn wh-secondary">
                        ƒêƒÉng k√Ω M√£ B·∫£o M·∫≠t
                      </button>
                    </div>
                  </div>
                  <div class="wh-card wh-danger-zone">
                    <h4 class="wh-section">Ng·ª´ng S·ª≠ D·ª•ng T√†i Kho·∫£n</h4>
                    <div class="wh-row" style="gap: 10px">
                      <button class="wh-btn wh-danger">
                        V√¥ Hi·ªáu H√≥a T√†i Kho·∫£n
                      </button>
                      <button class="wh-btn wh-outline">X√≥a T√†i Kho·∫£n</button>
                    </div>
                  </div>
                </div>
                <div class="wh-panel" data-tab="status">
                  <div class="wh-card">
                    <div class="wh-row wh-between">
                      <div>
                        <div class="wh-t">Tr·∫°ng th√°i t√†i kho·∫£n</div>
                        <div class="wh-sub">T√†i kho·∫£n ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</div>
                      </div>
                      <span class="wh-pill-ok">ƒêang ho·∫°t ƒë·ªông</span>
                    </div>
                  </div>
                </div>
              </main>
            </div>
          </div>

          <!-- ========== /WORKHUB SETTINGS OVERLAY ========== -->
          <!-- javascript m·ªü trang c√†i ƒë·∫∑t -->
          <script>
            const whOverlay = document.getElementById("whSettings");
            const whBtnOpen = document.getElementById("OpenSettings");
            const whBtnClose = document.getElementById("whClose");

            // Move settings overlay outside of profile popup
            if (whOverlay && whOverlay.parentElement.classList.contains('popup-content')) {
              document.body.appendChild(whOverlay);
            }

            if (whBtnOpen) {
              whBtnOpen.addEventListener("click", () => {
                whOverlay.style.display = "block";
                // Close profile popup when opening settings
                if (popupProfile) popupProfile.style.display = "none";
                if (userMenu) userMenu.style.display = "none";
              });
            }
            if (whBtnClose) {
              whBtnClose.addEventListener("click", () => {
                whOverlay.style.display = "none";
              });
            }
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && whOverlay.style.display === "block") {
                whOverlay.style.display = "none";
              }
            });

            // Tabs trong trang c√†i ƒë·∫∑t
            document.querySelectorAll(".wh-tab").forEach((tab) => {
              tab.addEventListener("click", () => {
                document
                  .querySelectorAll(".wh-tab")
                  .forEach((t) => t.classList.remove("wh-active"));
                document
                  .querySelectorAll(".wh-panel")
                  .forEach((p) => p.classList.remove("wh-show"));
                tab.classList.add("wh-active");
                document
                  .querySelector(`.wh-panel[data-tab="${tab.dataset.tab}"]`)
                  ?.classList.add("wh-show");
              });
            });

            // Sidebar highlight
            document.querySelectorAll(".wh-nav-item").forEach((btn) => {
              btn.addEventListener("click", () => {
                document
                  .querySelectorAll(".wh-nav-item")
                  .forEach((b) => b.classList.remove("wh-active"));
                btn.classList.add("wh-active");
              });
            });
          </script>
        </div>

        <script>
          // ===== CONFIG =====
          const USE_FETCH = true;
          const API = {
            createGroup: "/groups",
            updateProfile: "/api/profile/update",
          };

          // Xem tr∆∞·ªõc h√¨nh (background/avatar)
          function previewImage(evt, targetId) {
            const file = evt.target.files?.[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            const img = document.getElementById(targetId);
            if (img) {
              img.src = url;
            }
          }

          // Create-group UI removed. The sidebar button opens addmembers.html in a new tab.

          // ===== Theme =====
          const THEME_KEY = "workhub-theme";
          const themeBtn = document.getElementById("btnTheme");
          const themeIcon = document.getElementById("themeIcon");

          function getPreferredTheme() {
            const saved = localStorage.getItem(THEME_KEY);
            if (saved === "light" || saved === "dark") return saved;
            return window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: dark)").matches
              ? "dark"
              : "light";
          }
          function applyTheme(t) {
            document.documentElement.setAttribute("data-theme", t);
            themeBtn.title =
              t === "dark" ? "Chuy·ªÉn sang s√°ng" : "Chuy·ªÉn sang t·ªëi";
            themeBtn.setAttribute("aria-pressed", t === "dark");
            themeIcon.innerHTML =
              t === "dark"
                ? `<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke-width="2"/>`
                : `<circle cx="12" cy="12" r="5" stroke-width="2"/> 
                 <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-width="2"/>`;
          }
          function toggleTheme() {
            const current =
              document.documentElement.getAttribute("data-theme") || "light";
            const next = current === "dark" ? "light" : "dark";
            localStorage.setItem(THEME_KEY, next);
            applyTheme(next);
          }
          applyTheme(getPreferredTheme());
          themeBtn.addEventListener("click", toggleTheme);

          // Tabs (toolbar)
          document.querySelectorAll(".tab-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              document
                .querySelectorAll(".tab-btn")
                .forEach((b) => b.classList.remove("active"));
              btn.classList.add("active");
            });
          });

          // Right panels
          const notifPanel = document.getElementById("notifPanel");
          const notifPanelContent = document.getElementById("notifPanelContent");
          const calendarPanel = document.getElementById("calendarPanel");
          const calendarPanelContent = document.getElementById(
            "calendarPanelContent"
          );
          const closeNotifPanel = document.getElementById("closeNotifPanel");
          const closeCalendarPanel =
            document.getElementById("closeCalendarPanel");
          const btnNotif = document.getElementById("btnNotif");
          const btnCalendar = document.getElementById("btnCalendar");

          let panelOrder = [];
          function showPanel(panel) {
            if (panelOrder.includes(panel)) {
              closePanel(panel);
              return;
            }
            panelOrder = [panel, ...panelOrder];
            if (panelOrder.length > 2) panelOrder = panelOrder.slice(0, 2);

            notifPanel.classList.remove("top", "bottom", "show");
            calendarPanel.classList.remove("top", "bottom", "show");

            function renderCalendar() {
              calendarPanelContent.innerHTML = `
            <div class="calendar-card" id="calendarCard">
              <div class="calendar-head">
                <div>
                  <div class="calendar-title" id="titleDay">H√¥m nay</div>
                  <div class="calendar-sub" id="subMonth"></div>
                </div>
                <div>
                  <button class="btn" id="prevMth">‚óÄ</button>
                  <button class="btn" id="nextMth">‚ñ∂</button>
                </div>
              </div>
              <div class="calendar-grid" id="calGrid"></div>
            </div>
          `;
              setTimeout(initCalendar, 0);
            }

            if (panelOrder.length === 1) {
              if (panelOrder[0] === "notif") {
                notifPanel.classList.add("show", "top");
                renderNotif();
              } else {
                calendarPanel.classList.add("show", "top");
                renderCalendar();
              }
            } else {
              if (panelOrder[0] === "notif" && panelOrder[1] === "calendar") {
                notifPanel.classList.add("show", "top");
                calendarPanel.classList.add("show", "bottom");
                renderNotif();
              } else {
                calendarPanel.classList.add("show", "top");
                notifPanel.classList.add("show", "bottom");
                renderCalendar();
              }
            }
          }
          function closePanel(panel) {
            panelOrder = panelOrder.filter((p) => p !== panel);
            notifPanel.classList.remove("top", "bottom", "show");
            calendarPanel.classList.remove("top", "bottom", "show");
            if (panelOrder.length === 1) {
              if (panelOrder[0] === "notif") {
                notifPanel.classList.add("show", "top");
              } else {
                calendarPanel.classList.add("show", "top");
              }
            }
          }

          btnCalendar.onclick = () => showPanel("calendar");
          closeNotifPanel &&
            (closeNotifPanel.onclick = () => closePanel("notif"));
          closeCalendarPanel &&
            (closeCalendarPanel.onclick = () => closePanel("calendar"));
          document.addEventListener("mousedown", (e) => {
            if (
              notifPanel.classList.contains("show") &&
              !notifPanel.contains(e.target) &&
              !btnNotif.contains(e.target)
            )
              closePanel("notif");
            if (
              calendarPanel.classList.contains("show") &&
              !calendarPanel.contains(e.target) &&
              !btnCalendar.contains(e.target)
            )
              closePanel("calendar");
          });

          function initCalendar() {
            const calGrid = document.getElementById("calGrid");
            const titleDay = document.getElementById("titleDay");
            const subMonth = document.getElementById("subMonth");
            const prevMth = document.getElementById("prevMth");
            const nextMth = document.getElementById("nextMth");

            let view = new Date();
            function headText(d) {
              return new Intl.DateTimeFormat("vi-VN", {
                weekday: "short",
                month: "short",
                day: "2-digit",
              }).format(d);
            }
            function buildCalendar(date) {
              const y = date.getFullYear(),
                m = date.getMonth();
              titleDay.textContent = headText(new Date());
              subMonth.textContent = new Intl.DateTimeFormat("vi-VN", {
                month: "long",
                year: "numeric",
              })
                .format(new Date(y, m, 1))
                .toUpperCase();
              const first = new Date(y, m, 1);
              const start = (first.getDay() + 6) % 7; // Monday first
              const days = new Date(y, m + 1, 0).getDate();
              const prevDays = new Date(y, m, 0).getDate();
              const parts = [];
              ["T2", "T3", "T4", "T5", "T6", "T7", "CN"].forEach((d) =>
                parts.push(`<div class="dow">${d}</div>`)
              );
              for (let i = 0; i < 42; i++) {
                let label,
                  cls = "cell";
                if (i < start) {
                  label = prevDays - start + i + 1;
                  cls += " faded";
                } else if (i < start + days) {
                  label = i - start + 1;
                } else {
                  label = i - (start + days) + 1;
                  cls += " faded";
                }
                const today = new Date();
                if (
                  y === today.getFullYear() &&
                  m === today.getMonth() &&
                  label === today.getDate() &&
                  !cls.includes("faded")
                )
                  cls += " today";
                parts.push(`<div class="${cls}">${label}</div>`);
              }
              calGrid.innerHTML = parts.join("");
            }
            prevMth.addEventListener("click", () => {
              view.setMonth(view.getMonth() - 1);
              buildCalendar(view);
            });
            nextMth.addEventListener("click", () => {
              view.setMonth(view.getMonth() + 1);
              buildCalendar(view);
            });
            buildCalendar(view);
          }

          //ƒêƒÉng xu·∫•t v·ªõi h·ªôp tho·∫°i x√°c nh·∫≠n
          const logoutBtn = document.getElementById("Logout");
          const logoutConfirm = document.getElementById("popupLogout");
          const logoutConfirmYes = document.getElementById("logoutConfirmYes");
          const logoutConfirmNo = document.getElementById("logoutConfirmNo");

          logoutBtn && logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (logoutConfirm) {
              logoutConfirm.classList.add("active");
              logoutConfirm.setAttribute("aria-hidden", "false");
            } else {
              // chuy·ªÉn h∆∞·ªõng
              window.location.href = "/auth/logout";
            }
            // ·∫©n user menu
            if (userMenu) userMenu.style.display = "none";
          });

          // confirm
          logoutConfirmYes && logoutConfirmYes.addEventListener("click", () => {
            window.location.href = "/auth/logout";
          });
          logoutConfirmNo && logoutConfirmNo.addEventListener("click", () => {
            if (logoutConfirm) {
              logoutConfirm.classList.remove("active");
              logoutConfirm.setAttribute("aria-hidden", "true");
            }
          });
          const closeLogoutBtn = document.getElementById("closeLogoutBtn");
          closeLogoutBtn && closeLogoutBtn.addEventListener("click", () => {
            if (logoutConfirm) {
              logoutConfirm.classList.remove("active");
              logoutConfirm.setAttribute("aria-hidden", "true");
            }
          });

          // Nh·∫•n X ho·∫∑c click ra ngo√†i ƒë·ªÉ tho√°t
          if (logoutConfirm) {
            logoutConfirm.addEventListener("click", (e) => {
              if (e.target === logoutConfirm) {
                logoutConfirm.classList.remove("active");
                logoutConfirm.setAttribute("aria-hidden", "true");
              }
            });
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && logoutConfirm.classList.contains("active")) {
                logoutConfirm.classList.remove("active");
                logoutConfirm.setAttribute("aria-hidden", "true");
              }
            });
          }

        </script>
      </div>


      <!-- chi ti·∫øt c√¥ng vi·ªác -->
      <div class="popup-overlay" id="taskDetailModal"
        style="display:none; align-items:center; justify-content:center; backdrop-filter: blur(2px); z-index:1200;">
        <div class="popup-content" role="dialog" aria-modal="true"
          style="width:760px; max-width:95vw; max-height:90vh; overflow:auto; padding:16px; box-sizing:border-box;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="flex:1;text-align:center;font-weight:700;font-size: 20px;color: #22c55e;">Trao ƒë·ªïi c√¥ng vi·ªác
            </div>
            <button class="close-btn" id="closeTaskDetailBtn" aria-label="ƒê√≥ng" style="font-size:30px;">&times;</button>
          </div>
          <div style="height: 25px;"></div>

          <div id="taskDetailMain" style="display:flex;gap:16px">
            <!-- LEFT: creator info, attachments and actions (wireframe style) -->
            <div style="flex: 1 1 40%; display:flex;flex-direction:column;gap:12px">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div id="detailAvatar"
                  style="width:72px;height:72px;border-radius:50%;background:#cbd5e1;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;flex-shrink:0;">
                </div>
                <div style="flex:1;min-width:0;display:flex;flex-direction:column;gap:8px">
                  <input id="detailGroupName" readonly
                    style="padding:8px;border:1px solid var(--border-color);border-radius:6px;background:transparent;font-weight:600" />
                  <input id="detailUserName" readonly
                    style="padding:8px;border:1px solid var(--border-color);border-radius:6px;background:transparent;font-weight:600" />
                </div>
              </div>
              <div>
                <input id="detailTaskName" readonly
                  style="width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px;background:var(--surface);font-weight:700"
                  value="-" />
              </div>
              <div>
                <textarea id="detailDescription" readonly rows="5"
                  style="width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px;background:transparent;color:var(--text);resize:vertical"></textarea>
              </div>
              <div style="display:flex;align-items:center;gap:8px">
                <div style="display:flex;gap:6px;align-items:center">
                  <input type="text" id="detailStart" readonly
                    style="padding:6px;border:1px solid var(--border-color);border-radius:6px;width:150px"
                    placeholder="Ng√†y t·∫°o" />
                </div>
                <div style="display:flex;gap:6px;align-items:center">
                  <input type="text" id="detailDeadline" readonly
                    style="padding:6px;border:1px solid var(--border-color);border-radius:6px;width:150px"
                    placeholder="Deadline" />
                </div>
              </div>

              <!-- Creator attachments list (rendered by openTaskDetail) -->
              <div style="display:flex;flex-direction:column;gap:6px;width:100%;margin-top:6px">
                <div id="creatorAttachments"></div>
              </div>
              <div style="display:flex;justify-content:center;margin-top:6px">
                <button class="btn" id="acceptTaskBtn" type="button"
                  style="background:#2563eb;color:white;padding:8px 18px">Nh·∫≠n c√¥ng vi·ªác</button>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <div style="font-weight:700;text-align:center">File s·∫£n ph·∫©m</div>
                <div style="display:flex;gap:8px;justify-content:center">
                  <button class="btn" id="submitFileBtn" type="button">Ch·ªçn file</button>
                  <input type="file" id="submitFileInput" style="display:none" />
                </div>
                <div id="submitProductFiles"
                  style="min-height:30px;display:flex;flex-direction:column;gap:6px;align-items:center">
                </div>
                <div id="sanpham"></div>
              </div>
              <div style="display:flex;justify-content:center;margin-top:10px">
                <button class="btn" id="confirmTaskBtn" style="background:#16a34a;color:white;padding:8px 20px">X√°c
                  nh·∫≠n</button>
              </div>
            </div>

            <!-- RIGHT: chat area (moved) -->
            <div style="flex: 1 1 60%; display:flex;flex-direction:column;gap:10px">
              <div style="font-weight:700">Trao ƒë·ªïi</div>

              <div id="chatPlaceholder" class="outputChat"
                style="flex:1; min-height:240px; border:1px dashed var(--border-color); border-radius:6px; display:flex;align-items:center;justify-content:center;color:var(--text-muted); padding:12px;">
              </div>

              <div class="inputChat">
                <input type="file" id="fileInput" hidden />
                <button onclick="document.getElementById('fileInput').click()" class="sendFile">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path
                      d="M21.44 11.05l-9.19 9.19a5 5 0 01-7.07-7.07l9.19-9.19a3 3 0 014.24 4.24l-9.2 9.2a1 1 0 01-1.41-1.41l8.49-8.49" />
                  </svg>
                </button>
                <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn ...">
                <button class="sendMessage">G·ª≠i</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========================== Chat c√¥ng vi·ªác ==========================-->
      <!-- Socket.io client -->
      <script src="/socket.io/socket.io.js"></script>

      <script>
        // ===================== OPEN TASK DETAIL =====================

        // H√†m m·ªü modal chi ti·∫øt c√¥ng vi·ªác
        async function openTaskDetail(task) {

          const modal = document.getElementById('taskDetailModal');
          if (!modal) return;

          // Chu·∫©n ho√° taskId (v√¨ ƒë√¥i khi backend tr·∫£ id ho·∫∑c _id)
          const taskId =
            task.id ||
            task._id ||
            (task._doc && (task._doc._id || task._doc.id)) ||
            '';

          // L·∫•y c√°c element giao di·ªán
          const avatarEl = document.getElementById('detailAvatar');
          const nameEl = document.getElementById('detailUserName');
          const groupEl = document.getElementById('detailGroupName');
          const taskNameEl = document.getElementById('detailTaskName');
          const descEl = document.getElementById('detailDescription');
          const startEl = document.getElementById('detailStart');
          const deadlineEl = document.getElementById('detailDeadline');
          const creatorAttachmentsEl = document.getElementById('creatorAttachments');
          const submitProductFiles = document.getElementById('submitProductFiles');

          const acceptBtn = document.getElementById('acceptTaskBtn');
          const submitBtn = document.getElementById('submitFileBtn');
          const submitInput = document.getElementById('submitFileInput');
          const chatPlaceholder = document.getElementById('chatPlaceholder');

          const creatorId = task.createdBy;
          const assigneeIds = (task.assignees || []).map(x => x.userId || x.id);

          // -----------------------------------------------------------------------------

          // ------------------------------------------------------------------------------

          // Helper set text
          function setTextOrValue(el, text) {
            if (!el) return;
            if ('value' in el) el.value = text || '';
            else el.textContent = text || '';
          }

          const userName = task.ownerName || task.creatorName || "Ng∆∞·ªùi t·∫°o";
          setTextOrValue(nameEl, userName);
          setTextOrValue(groupEl, task.groupName || '');

          // Avatar
          const { name: creatorName, avatar: creatorAvatar } = getCreatorInfo(task);
          avatarEl.innerHTML = "";
          if (creatorAvatar) {
            const img = document.createElement("img");
            img.src = creatorAvatar;
            img.style = "width:100%;height:100%;border-radius:50%;object-fit:cover";
            avatarEl.appendChild(img);
          } else {
            avatarEl.textContent = (creatorName || "?").charAt(0).toUpperCase();
          }

          // N·ªôi dung task
          setTextOrValue(taskNameEl, task.taskName || task.name || '');
          setTextOrValue(descEl, task.description || '');
          setTextOrValue(startEl, task.createdAt ? new Date(task.createdAt).toLocaleDateString('vi-VN') : '');
          setTextOrValue(deadlineEl, task.deadline ? new Date(task.deadline).toLocaleDateString('vi-VN') : '');

          // b·ªô icon 
          const iconMap = {
            pdf: "picture_as_pdf",
            doc: "description",
            docx: "description",
            xls: "table",
            xlsx: "table",
            png: "image",
            jpg: "image",
            jpeg: "image",
            svg: "image",
            zip: "folder_zip",
            rar: "folder_zip",
            py: "terminal",
            js: "javascript",
            default: "insert_drive_file"
          };

          // 1Ô∏è‚É£ L·∫§Y FILE ƒê√çNH K√àM ‚Äî ATTACHMENTS
          (async () => {
            creatorAttachmentsEl.innerHTML = `<span style="font-size:0.85rem;color:var(--text-muted)">ƒêang t·∫£i file...</span>`;

            try {
              const res = await fetch(`/tasks/${taskId}/files`, { credentials: "include" });
              const files = res.ok ? await res.json() : [];

              creatorAttachmentsEl.innerHTML = "";

              if (!files.length) {
                creatorAttachmentsEl.innerHTML = `<span class="empty">Kh√¥ng c√≥ file</span>`;
                return;
              }

              files.forEach(f => {
                const item = document.createElement("div");
                item.className = "file_item";

                const created = new Date(f.createdAt);
                const timeStr = created.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
                const dateStr = created.toLocaleDateString("vi-VN");

                // Format size
                const fileSizeKB = (f.fileSize / 1024).toFixed(1);

                // Icon theo file type
                const ext = f.fileName.split(".").pop().toLowerCase();
                const icon = iconMap[ext] || iconMap.default;

                item.innerHTML = `
  <div class="file_left">
    <div class="file_icon">
      <span class="material-symbols-rounded">${icon}</span>
    </div>

    <div class="file_info">
      <a href="${f.filePath}" target="_blank" class="file_name">${f.fileName}</a>
      <div class="file_meta">${dateStr} - ${timeStr}</div>
    </div>
  </div>

  <div class="file_right">${fileSizeKB} KB</div>
`;

                creatorAttachmentsEl.appendChild(item);
              });

            } catch (err) {
              console.error("L·ªói t·∫£i t·ªáp ƒë√≠nh k√®m:", err);
              creatorAttachmentsEl.innerHTML = `<span class="error">L·ªói t·∫£i file</span>`;
            }
          })();

          // 2Ô∏è‚É£ L·∫§Y FILE N·ªòP ‚Äî SUBMISSIONS
          (async () => {
            submitProductFiles.innerHTML = `<span style="font-size:0.85rem;color:var(--text-muted)">ƒêang t·∫£i file...</span>`;

            try {
              const res = await fetch(`/tasks/${taskId}/submissions`, { credentials: "include" });
              const files = res.ok ? await res.json() : [];

              submitProductFiles.innerHTML = "";

              if (!files.length) {
                submitProductFiles.innerHTML = `<span class="empty">Ch∆∞a c√≥ file n·ªôp</span>`;
                return;
              }

              files.forEach(f => {
                const item = document.createElement("div");
                item.className = "submit_item";

                const ext = f.fileName.split(".").pop().toLowerCase();
                const icon = iconMap[ext] || iconMap.default;

                const dateStr = new Date(f.createdAt).toLocaleDateString("vi-VN");
                const timeStr = new Date(f.createdAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

                item.innerHTML = `
    <div class="submit_left">
      <div class="submit_icon">
        <span class="material-symbols-rounded">${icon}</span>
      </div>

      <div class="submit_info">
        <a href="${f.filePath}" class="submit_name" target="_blank">${f.fileName}</a>
        <div class="submit_user">Ng∆∞·ªùi n·ªôp: ${f.userName || "Kh√¥ng r√µ"}</div>
      </div>
    </div>

    <div class="submit_time">
      ${dateStr} - ${timeStr}
    </div>
  `;
                submitProductFiles.appendChild(item);
              });

            } catch (err) {
              console.error("L·ªói t·∫£i file n·ªôp:", err);
              submitProductFiles.innerHTML = `<span class="error">L·ªói t·∫£i file</span>`;
            }
          })();

          // X√≥a khu v·ª±c g·ª≠i t·ªáp s·∫£n ph·∫©m
          submitProductFiles.innerHTML = '';

          // 3Ô∏è‚É£ N√öT NH·∫¨N C√îNG VI·ªÜC
          // Ch·∫•p nh·∫≠n (Nh·∫≠n): t·∫£i xu·ªëng t·ªáp ƒë√≠nh k√®m v√† ƒë·∫∑t tr·∫°ng th√°i c√° nh√¢n th√†nh in_progress
          acceptBtn.onclick = async () => {
            // Ki·ªÉm tra xem ng∆∞·ªùi d√πng hi·ªán t·∫°i c√≥ ph·∫£i ng∆∞·ªùi ƒë∆∞·ª£c giao kh√¥ng

            try {
              // L·∫•y file ƒë√≠nh k√®m ƒë·ªÉ t·∫£i v·ªÅ
              const res = await fetch(`/tasks/${taskId}/files`, { credentials: "include" });
              const files = res.ok ? await res.json() : [];

              files.forEach(f => {
                if (f.filePath) window.open(f.filePath, "_blank");
              });

              // C·∫≠p nh·∫≠t tr·∫°ng th√°i ri√™ng: nh·∫≠n task (use existing helper to update UI)
              if (CURRENT_USER_ID) {
                await updateAssigneeStatus(taskId, CURRENT_USER_ID, 'in_progress');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i chung
                const globalRes = await fetch(`/tasks/${taskId}/status`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({}),
                  credentials: "include"
                });
                if (!globalRes.ok) console.warn('Warning: global status update failed');
              }

              showToast("B·∫°n ƒë√£ nh·∫≠n c√¥ng vi·ªác");
            } catch (err) {
              console.error(err);
              showToast("L·ªói nh·∫≠n c√¥ng vi·ªác", "error");
            }
          };

          // 4Ô∏è‚É£ UPLOAD FILE S·∫¢N PH·∫®M
          let selectedProductFiles = [];

          submitBtn.onclick = () => submitInput.click();

          submitInput.onchange = () => {
            const files = Array.from(submitInput.files);
            if (!files.length) return;

            selectedProductFiles = files;
            submitProductFiles.innerHTML = "";

            files.forEach((file, index) => {
              const wrap = document.createElement("div");
              wrap.className = "product-file-item";

              wrap.innerHTML = `
        <div class="product-file-info">
          <div class="product-file-name">${file.name}</div>
          <div class="product-file-size">${(file.size / 1024).toFixed(1)} KB</div>
        </div>
        <button class="product-file-remove">X√≥a</button>
      `;

              wrap.querySelector(".product-file-remove").onclick = () => {
                selectedProductFiles.splice(index, 1);
                wrap.remove();
              };

              submitProductFiles.appendChild(wrap);
            });
          };

          // 5Ô∏è‚É£ N·ªòP FILE
          const confirmBtn = document.getElementById("confirmTaskBtn");
          confirmBtn.onclick = async () => {
            if (!selectedProductFiles.length) {
              showToast("B·∫°n ch∆∞a ch·ªçn file s·∫£n ph·∫©m", "error");
              return;
            }

            try {
              for (const file of selectedProductFiles) {
                const fd = new FormData();
                fd.append("file", file);
                fd.append("taskId", taskId);
                if (CURRENT_USER_ID) fd.append("userId", CURRENT_USER_ID);

                const res = await fetch(`/tasks/${taskId}/submit`, {
                  method: "POST",
                  body: fd,
                  credentials: "include"
                });

                const data = await res.json();

                const wrap = document.createElement("div");
                wrap.className = "product-file-item";

                wrap.innerHTML = `
          <a href="${data.file.url}" target="_blank" class="product-file-name">
            ${data.file.name}
          </a>
        `;

                submitProductFiles.appendChild(wrap);
              }

              submitInput.value = "";
              selectedProductFiles = [];

              // C·∫≠p nh·∫≠t tr·∫°ng th√°i ri√™ng: ƒë√£ ho√†n th√†nh (use helper to update UI)
              if (CURRENT_USER_ID) {
                await updateAssigneeStatus(taskId, CURRENT_USER_ID, 'done');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i chung
                const globalRes = await fetch(`/tasks/${taskId}/status`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({}),
                  credentials: "include"
                });
                if (!globalRes.ok) console.warn('Warning: global status update failed');
              }

              showToast("N·ªôp file th√†nh c√¥ng");

            } catch (err) {
              console.error(err);
              showToast("L·ªói khi n·ªôp file", "error");
            }
          };

          //==============SHOW MODAL============

          modal.style.display = "flex";
          modal.setAttribute("aria-hidden", "false");

          const closeBtn = document.getElementById("closeTaskDetailBtn");
          closeBtn.onclick = closeTaskDetail;

          modal.addEventListener("click", function onOutside(e) {
            if (e.target === modal) {
              modal.removeEventListener("click", onOutside);
              closeTaskDetail();
            }
          });

          document.addEventListener("keydown", function esc(e) {
            if (e.key === "Escape") {
              document.removeEventListener("keydown", esc);
              closeTaskDetail();
            }
          });
        }

        // ƒê√≥ng modal
        function closeTaskDetail() {
          const modal = document.getElementById("taskDetailModal");
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
        }

        // Ng∆∞·ªùi ƒë∆∞·ª£c giao b·∫•m Nh·∫≠n c√¥ng vi·ªác
        async function acceptTask(taskId, userId, sampleFileUrl) {
          try {
            // T·∫£i file m·∫´u n·∫øu c√≥
            if (sampleFileUrl) {
              const a = document.createElement("a");
              a.href = sampleFileUrl;
              a.download = "";
              a.click();
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i ri√™ng th√†nh "in_progress"
            await fetch(`/tasks/${taskId}/assignees/${userId}/status`, {
              method: "PUT",
              credentials: 'include',
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: "in_progress" })
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i chung
            await updateTaskGlobalStatus(taskId);

            openTaskDetail({ id: taskId });

          } catch (err) {
            console.error("L·ªói nh·∫≠n c√¥ng vi·ªác:", err);
            alert("L·ªói nh·∫≠n c√¥ng vi·ªác");
          }
        }

        // Ng∆∞·ªùi ƒë∆∞·ª£c giao n·ªôp file s·∫£n ph·∫©m
        async function submitTaskProduct(taskId, userId, fileInput) {
          try {
            const file = fileInput.files[0];
            if (!file) return alert("H√£y ch·ªçn file s·∫£n ph·∫©m!");

            const formData = new FormData();
            formData.append("file", file);

            // Upload file s·∫£n ph·∫©m
            await fetch(`/tasks/${taskId}/assignees/${userId}/submit`, {
              method: "POST",
              body: formData
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i ri√™ng th√†nh "done"
            await fetch(`/tasks/${taskId}/assignees/${userId}/status`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: "done" })
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i chung
            await updateTaskGlobalStatus(taskId);

            openTaskDetail({ id: taskId });

          } catch (err) {
            console.error("L·ªói n·ªôp b√†i:", err);
            alert("L·ªói n·ªôp b√†i");
          }
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i chung c·ªßa Task
        async function updateTaskGlobalStatus(taskId) {
          try {
            // L·∫•y danh s√°ch tr·∫°ng th√°i t·ª´ng ng∆∞·ªùi
            const res = await fetch(`/tasks/${taskId}/assignees`);
            const assignees = await res.json();

            const statuses = assignees.map(a => a.status);

            let globalStatus = "pending";

            if (statuses.some(s => s === "in_progress")) {
              globalStatus = "in_progress";
            }

            if (statuses.every(s => s === "done")) {
              globalStatus = "done";
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i chung
            await fetch(`/tasks/${taskId}/status`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: globalStatus })
            });

          } catch (err) {
            console.error("L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i chung:", err);
          }
        }

        function escapeHtml(str) {
          return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

      </script>

      <script>
        document.addEventListener("DOMContentLoaded", async () => {
          const socket = io(); // t·ª± ƒë·ªông k·∫øt n·ªëi ƒë·∫øn backend

          const chatId = result;

          const userId = "<%= user.id %>";
          const username = "<%= user.name %>";
          const avatarPath = "<%= user.avatarPath || '/uploads/default-avatar.png' %>";

          const outputChat = document.querySelector(".outputChat");
          const input = document.getElementById("messageInput");
          const sendBtn = document.querySelector(".sendMessage");

          // ========== THAM GIA PH√íNG CHAT ==========
          socket.emit("joinChat", chatId);

          // ========== LOAD TIN NH·∫ÆN C≈® ==========
          async function loadMessages() {
            try {
              console.log("Fetching messages from:", `/chat/${chatId}/messages`);
              const res = await fetch(`/chat/${chatId}/messages`);
              console.log("Response status:", res.status);
              if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn");
              const messages = await res.json();
              outputChat.innerHTML = "";
              messages.forEach(renderMessage);
              outputChat.scrollTop = outputChat.scrollHeight;
            } catch (err) {
              console.error("L·ªói khi loadMessages:", err);
              outputChat.innerHTML = `<div style="color:red;padding:10px;">L·ªói t·∫£i tin nh·∫Øn.</div>`;
            }
          }

          // ========== HI·ªÇN TH·ªä TIN NH·∫ÆN ==========  
          function renderMessage(msg) {
            const mine = msg.senderId === "<%= user.id %>";
            const time = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

            // build message content (handle file vs text)
            let contentHtml = "";
            if (msg.messageType === "file") {
              // prefer msg.fileUrl then msg.filePath
              const url = msg.fileUrl || msg.filePath || msg.filePath || msg.fileUrl;
              const name = msg.content || (msg.fileName || url?.split('/').pop() || 'T·ªáp ƒë√≠nh k√®m');
              const ext = (name || '').split('.').pop()?.toLowerCase() || '';
              const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'];
              const videoTypes = ['mp4', 'webm', 'ogg'];

              if (imageTypes.includes(ext)) {
                contentHtml = `<a href="${url}" target="_blank"><img src="${url}" class="chat-file-image" style="max-width:300px;display:block;border-radius:8px"></a>`;
              } else if (videoTypes.includes(ext)) {
                contentHtml = `<video controls src="${url}" class="chat-file-video" style="max-width:320px;display:block;border-radius:8px"></video>`;
              } else {
                contentHtml = `<a href="${url}" download style="text-decoration:underline;color:inherit;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21.44 11.05l-9.19 9.19a5 5 0 01-7.07-7.07l9.19-9.19a3 3 0 014.24 4.24l-9.2 9.2a1 1 0 01-1.41-1.41l8.49-8.49"/>
    </svg>
                ${name}</a>`;
              }
            } else {
              contentHtml = msg.content || '';
            }

            const div = document.createElement("div");
            div.classList.add("chat-row", mine ? "mine" : "other");

            div.innerHTML = `
    ${!mine ? `
      <img class="avatar" src="${msg.avatarPath || '/uploads/default-avatar.png'}" alt="">
      <div class="chat-content">
        <div class="name">${msg.username || 'Ng∆∞·ªùi d√πng'}</div>
        <div class="bubble bubble-other">${contentHtml}</div>
        <div class="time-other">${time}</div>
      </div>
    ` : `
      <div class="chat-content">
        <div class="bubble bubble-mine">${contentHtml}</div>
        <div class="time-mine">${time}</div>
      </div>
      <img class="avatar" src="${msg.avatarPath || '/uploads/default-avatar.png'}" alt="">
    `}
  `;

            document.querySelector(".outputChat").appendChild(div);
          }

          // ========== G·ª¨I TIN NH·∫ÆN ==========
          sendBtn.addEventListener("click", sendMessage);
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
          });

          function sendMessage() {
            const content = input.value.trim();
            if (!content) return;

            socket.emit("sendMessage", {
              chatId,
              senderId: userId,
              content,
              messageType: "text"
            });

            input.value = "";
          }

          // ========== NH·∫¨N TIN NH·∫ÆN M·ªöI ==========
          socket.on("newMessage", (msg) => {
            const { type, fileName, filePath } = msg;

            // N·∫øu l√† file
            if (type === "file" && filePath) {
              const fileType = getFileType(fileName); // H√†m x√°c ƒë·ªãnh lo·∫°i file

              let html = "";

              switch (fileType) {
                case "image":
                  html = `
          <div class="message">
            <img src="${filePath}" class="chat-image" alt="${fileName}">
          </div>
        `;
                  break;

                case "video":
                  html = `
          <div class="message">
            <video controls class="chat-video">
              <source src="${filePath}" type="video/mp4">
              Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
            </video>
          </div>
        `;
                  break;

                case "document":
                  html = `
          <div class="message file-message">
            üìÑ <a href="${filePath}" download>${fileName}</a>
          </div>
        `;
                  break;

                case "archive":
                  html = `
          <div class="message file-message">
            üóÇ <a href="${filePath}" download>${fileName}</a>
          </div>
        `;
                  break;

                case "code":
                  html = `
          <div class="message file-message">
            üíª <a href="${filePath}" download>${fileName}</a>
          </div>
        `;
                  break;

                default:
                  html = `
          <div class="message file-message">
            üìé <a href="${filePath}" download>${fileName}</a>
          </div>
        `;
              }

              chatBox.innerHTML += html;
            } else {
              // N·∫øu kh√¥ng ph·∫£i file, render b√¨nh th∆∞·ªùng
              renderMessage(msg);
            }

            // Cu·ªôn chat xu·ªëng cu·ªëi
            outputChat.scrollTop = outputChat.scrollHeight;
          });


          // ========== NG·∫ÆT K·∫æT N·ªêI ==========
          window.addEventListener("beforeunload", () => {
            socket.emit("leaveChat", chatId);
            socket.disconnect();
          });

          // T·∫£i tin nh·∫Øn ban ƒë·∫ßu
          loadMessages();

          // G·ª≠i file: x·ª≠ l√Ω upload r·ªìi emit sendMessage (placed inside DOMContentLoaded so `socket` is available)
          const fileInputEl = document.getElementById("fileInput");
          if (fileInputEl) {
            fileInputEl.addEventListener("change", async (e) => {
              const file = e.target.files?.[0];
              if (!file) return;

              const form = new FormData();
              form.append("file", file);

              try {
                const res = await fetch("/chat/upload", {
                  method: "POST",
                  body: form,
                  credentials: "same-origin",
                });
                const data = await res.json();
                if (!res.ok || !data?.success) {
                  console.error("Upload failed", data);
                  showToast(data?.error || "Kh√¥ng th·ªÉ upload t·ªáp.", "error");
                  fileInputEl.value = "";
                  return;
                }

                const filePath = data.filePath;

                socket.emit("sendMessage", {
                  chatId,
                  senderId: userId,
                  content: file.name,
                  messageType: "file",
                  filePath,
                  fileUrl: filePath,
                });

                fileInputEl.value = "";
              } catch (err) {
                console.error("Upload error", err);
                showToast("L·ªói khi upload t·ªáp.", "error");
                fileInputEl.value = "";
              }
            });
          }

        });


        function getFileType(filename) {
          const ext = filename.split('.').pop().toLowerCase();

          const imageTypes = ["jpg", "jpeg", "png", "gif", "webp"];
          const videoTypes = ["mp4", "webm", "mkv"];
          const docTypes = ["pdf", "doc", "docx", "xls", "xlsx", "ppt", "pptx"];
          const zipTypes = ["zip", "rar", "7z"];
          const codeTypes = ["txt", "py", "js", "css", "html", "json"];

          if (imageTypes.includes(ext)) return "image";
          if (videoTypes.includes(ext)) return "video";
          if (docTypes.includes(ext)) return "document";
          if (zipTypes.includes(ext)) return "archive";
          if (codeTypes.includes(ext)) return "code";

          return "other";
        }

        // ========== T·ª∞ ƒê·ªòNG M·ªû TASK KHI C√ì QUERY openTask ==========
        document.addEventListener("DOMContentLoaded", async () => {
          const params = new URLSearchParams(window.location.search);
          const taskId = params.get("openTask");
          if (!taskId) return;

          // Ch·ªù 300ms ƒë·ªÉ task ƒë∆∞·ª£c render xong
          setTimeout(() => {
            // Chuy·ªÉn sang tab "ƒê∆∞·ª£c giao"
            document.getElementById("btnReceived").click();

            const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);

            if (taskEl) {
              taskEl.scrollIntoView({ behavior: "smooth", block: "center" });

              // Highlight nh·∫π
              taskEl.style.transition = "background 0.4s";
              taskEl.style.background = "#FFF3B0";   // v√†ng nh·∫°t

              setTimeout(() => {
                taskEl.style.background = "";
              }, 1500);
            }
          }, 300);
        });
      </script>

      <!-- <script>
          const notifBtn = document.getElementById("notifbutton");
          const popup = document.getElementById("notificationPopup");
          const closeBtn = document.getElementById("homeCloseNotifBtn");
          const notifList = document.getElementById("homeNotifList");

          // M·ªü popup khi nh·∫•p n√∫t chu√¥ng
          notifBtn.addEventListener("click", () => {
            popup.style.display = "block";
            loadHomeNotifications();
            updateNotifBadge(); // c·∫≠p nh·∫≠t s·ªë ch∆∞a ƒë·ªçc khi m·ªü popup
          });


          // ƒê√≥ng popup
          closeBtn.addEventListener("click", () => {
            popup.style.display = "none";
          });

          // ===============================
          // üìå G·ªçi API l·∫•y th√¥ng b√°o
          // ===============================
          async function loadHomeNotifications() {
            try {
              const response = await fetch("/groups/notifications");
              const notifs = await response.json();

              notifList.innerHTML = notifs.map(n => `
            <div class="notif-item"
                 data-id="${n.id}"
                 data-task-id="${n.referenceId || ''}"
                 style="padding:10px 12px;border-bottom:1px solid #ddd;
                        cursor:pointer;background:${n.isRead ? 'white' : '#eaffea'}">

                <b>${n.message}</b>
                <div style="font-size:0.8rem;color:gray;">
                    ${new Date(n.createdAt).toLocaleString()}
                </div>
            </div>
        `).join("");
            } catch (err) {
              notifList.innerHTML = "<p style='color:red;'>L·ªói t·∫£i th√¥ng b√°o.</p>";
              console.error(err);
            }
          }

          // ===============================
          // üìå Click v√†o th√¥ng b√°o ‚Üí chuy·ªÉn ƒë·∫øn ƒë√∫ng task
          // ===============================
          notifList.addEventListener("click", async (e) => {
            const item = e.target.closest(".notif-item");
            if (!item) return;

            const notifId = item.dataset.id;
            const taskId = item.dataset.taskId;

            // ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
            await fetch("/groups/notifications/read", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: notifId })
            });

            // Chuy·ªÉn ƒë·∫øn trang v·ªõi ?openTask=xxx
            if (taskId) {
              window.location.href = `/?openTask=${taskId}`;
            }
          });

          async function updateNotifBadge() {
            try {
              const res = await fetch("/groups/notifications");
              const notifs = await res.json();

              const unread = notifs.filter(n => !n.isRead).length;
              const badge = document.getElementById("notifBadge");

              if (unread > 0) {
                badge.style.display = "inline-block";
                badge.textContent = unread > 99 ? "99+" : unread;
              } else {
                badge.style.display = "none";
              }
            } catch (err) {
              console.error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t badge:", err);
            }
          }


        </script> -->
      <%- include("chatbot") %>

        <script>
          const notifBtn = document.getElementById("notifbutton");
          const popup = document.getElementById("notificationPopup");
          const closePopupBtn = document.getElementById("closePopupBtn");

          // M·ªü popup khi nh·∫•p v√†o n√∫t
          notifBtn.addEventListener("click", () => {
            popup.style.display = "flex";
            loadNotifications();   // t·∫£i d·ªØ li·ªáu t·ª´ server
          });

          // ƒê√≥ng popup
          closePopupBtn.addEventListener("click", () => {
            popup.style.display = "none";
          });

          // ƒê√≥ng khi b·∫•m ra ngo√†i popup
          popup.addEventListener("click", (e) => {
            if (e.target === popup) popup.style.display = "none";
          });

          // ===============================
          //  L·∫§Y D·ªÆ LI·ªÜU T·ª™ API
          // ===============================
          async function loadNotifications() {
            const container = document.querySelector("#notificationPopup .notif-content");

            try {
              const res = await fetch("/groups/notifications");
              const notifs = await res.json();

              if (!Array.isArray(notifs) || notifs.length === 0) {
                container.innerHTML = `<p style="text-align:center;color:gray;">Kh√¥ng c√≥ th√¥ng b√°o.</p>`;
                return;
              }

              container.innerHTML = notifs.map(n => `
            <div class="notif-item" 
                 style="padding:10px 12px;border-bottom:1px solid #ddd;
                        background:${n.isRead ? 'white' : '#eaffea'}">
                
                ${n.message}
                <div style="font-size:0.8rem;color:gray;">
                    ${new Date(n.createdAt).toLocaleString()}
                </div>
            </div>
        `).join("");

            } catch (err) {
              container.innerHTML = `<p style="color:red;">L·ªói t·∫£i th√¥ng b√°o</p>`;
              console.error("Notif error:", err);
            }
          }
        </script>


</body>

</html>